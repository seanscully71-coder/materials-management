<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materials Management System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif;">
            <div style="text-align: center;">
                <div class="loader"></div>
                <p style="color: #666;">Loading Materials Management System...</p>
                <p id="status" style="color: #999; font-size: 12px; margin-top: 10px;">Initializing...</p>
            </div>
        </div>
    </div>

    <script>
        // Diagnostic function
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.textContent = message;
            console.log('Status:', message);
        }

        // Check library loading with timeout
        let checkCount = 0;
        const maxChecks = 50; // 5 seconds max
        
        function checkLibraries() {
            checkCount++;
            updateStatus(`Checking libraries... (${checkCount}/${maxChecks})`);
            
            const reactLoaded = typeof React !== 'undefined';
            const reactDomLoaded = typeof ReactDOM !== 'undefined';
            const babelLoaded = typeof Babel !== 'undefined';
            const rechartsLoaded = typeof Recharts !== 'undefined';
            
            console.log('Library status:', {
                React: reactLoaded,
                ReactDOM: reactDomLoaded,
                Babel: babelLoaded,
                Recharts: rechartsLoaded
            });
            
            // Wait for Recharts too, but make it optional
            if (reactLoaded && reactDomLoaded && babelLoaded) {
                if (!rechartsLoaded) {
                    console.warn('Recharts failed to load - charts will be disabled but app will still work');
                }
                updateStatus('Libraries loaded! Starting app...');
                setTimeout(initializeApp, 500);
                return;
            }
            
            if (checkCount >= maxChecks) {
                document.getElementById('root').innerHTML = `
                    <div style="padding: 40px; font-family: sans-serif; max-width: 600px; margin: 0 auto;">
                        <h1 style="color: #dc2626;">Loading Error</h1>
                        <p>Some required libraries failed to load. This might be due to:</p>
                        <ul style="line-height: 1.8;">
                            <li>Internet connection issues</li>
                            <li>Corporate firewall blocking CDN libraries</li>
                            <li>Ad blocker interference</li>
                            <li>Browser security settings</li>
                        </ul>
                        <h3>What loaded:</h3>
                        <ul>
                            <li>React: ${reactLoaded ? '✓' : '✗ REQUIRED'}</li>
                            <li>ReactDOM: ${reactDomLoaded ? '✓' : '✗ REQUIRED'}</li>
                            <li>Babel: ${babelLoaded ? '✓' : '✗ REQUIRED'}</li>
                            <li>Recharts: ${rechartsLoaded ? '✓' : '✗ (optional - charts disabled)'}</li>
                        </ul>
                        <h3>Try this:</h3>
                        <ol style="line-height: 1.8;">
                            <li>Refresh the page (Ctrl+Shift+R)</li>
                            <li>Disable ad blockers</li>
                            <li>Try a different browser</li>
                            <li>Download and open the file locally</li>
                        </ol>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
                return;
            }
            
            setTimeout(checkLibraries, 100);
        }
        
        function initializeApp() {
            try {
                updateStatus('Compiling application...');
                console.log('App initialization started');
                
                // Set a timeout to detect if compilation hangs
                setTimeout(() => {
                    const root = document.getElementById('root');
                    // If still showing loading after 10 seconds, something went wrong
                    if (root.innerHTML.includes('Loading Materials Management System')) {
                        console.error('Compilation timeout - Babel may have failed');
                        root.innerHTML = `
                            <div style="padding: 40px; font-family: sans-serif; max-width: 600px; margin: 0 auto;">
                                <h1 style="color: #dc2626;">Compilation Timeout</h1>
                                <p>The application failed to compile within 10 seconds. This usually means:</p>
                                <ul style="line-height: 1.8;">
                                    <li>Babel (the JavaScript compiler) encountered an error</li>
                                    <li>Your browser may not support the required features</li>
                                    <li>A browser extension is interfering</li>
                                </ul>
                                <h3>Try these solutions:</h3>
                                <ol style="line-height: 1.8;">
                                    <li><strong>Open the browser console</strong> (F12) to see detailed errors</li>
                                    <li><strong>Try a different browser</strong> (Chrome, Firefox, or Edge recommended)</li>
                                    <li><strong>Disable browser extensions</strong> temporarily</li>
                                    <li><strong>Download and open locally</strong> instead of using GitHub Pages</li>
                                </ol>
                                <div style="margin-top: 20px;">
                                    <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                        Try Again
                                    </button>
                                    <button onclick="window.open('https://app.netlify.com/drop', '_blank')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                        Try Netlify Instead
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }, 10000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('root').innerHTML = `
                    <div style="padding: 40px; font-family: sans-serif;">
                        <h1 style="color: #dc2626;">Initialization Error</h1>
                        <p>Error: ${error.message}</p>
                        <pre style="background: #f3f4f6; padding: 15px; border-radius: 5px; overflow-x: auto;">${error.stack}</pre>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Reload Page
                        </button>
                    </div>
                `;
            }
        }
        
        // Start checking after a brief delay to let scripts load
        setTimeout(checkLibraries, 500);
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Safely get Recharts components
        let LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer;
        if (typeof Recharts !== 'undefined') {
            ({ LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts);
        }

        // Lucide icons as SVG components
        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const TrendingUp = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );

        const Package = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
        );

        const FileText = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
        );

        const Clock = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        function MaterialsManagement() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [contracts, setContracts] = useState([]);
            const [inventory, setInventory] = useState({
                aluminum5052: { quantity: 0, unit: 'lbs' },
                stainless304: { quantity: 0, unit: 'lbs' }
            });
            const [usageHistory, setUsageHistory] = useState([]);
            const [marketPrices, setMarketPrices] = useState([]);
            const [showContractForm, setShowContractForm] = useState(false);
            const [showUsageForm, setShowUsageForm] = useState(false);
            const [showMarketPriceForm, setShowMarketPriceForm] = useState(false);
            const [showInventoryForm, setShowInventoryForm] = useState(false);
            const [editingContract, setEditingContract] = useState(null);
            const [editingMarketPrice, setEditingMarketPrice] = useState(null);
            const [editingUsage, setEditingUsage] = useState(null);

            // Load data from localStorage
            useEffect(() => {
                const savedContracts = localStorage.getItem('contracts');
                const savedInventory = localStorage.getItem('inventory');
                const savedUsageHistory = localStorage.getItem('usageHistory');
                const savedMarketPrices = localStorage.getItem('marketPrices');
                
                if (savedContracts) setContracts(JSON.parse(savedContracts));
                if (savedInventory) setInventory(JSON.parse(savedInventory));
                if (savedUsageHistory) setUsageHistory(JSON.parse(savedUsageHistory));
                if (savedMarketPrices) setMarketPrices(JSON.parse(savedMarketPrices));
            }, []);

            // Save data to localStorage
            useEffect(() => {
                localStorage.setItem('contracts', JSON.stringify(contracts));
            }, [contracts]);

            useEffect(() => {
                localStorage.setItem('inventory', JSON.stringify(inventory));
            }, [inventory]);

            useEffect(() => {
                localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
            }, [usageHistory]);

            useEffect(() => {
                localStorage.setItem('marketPrices', JSON.stringify(marketPrices));
            }, [marketPrices]);

            const ContractForm = ({ onClose, onSubmit, initialData = null }) => {
                const [formData, setFormData] = useState(initialData || {
                    id: Date.now(),
                    material: 'aluminum5052',
                    vendor: '',
                    pricePerLb: '',
                    totalQuantity: '',
                    remainingQuantity: '',
                    avgMonthlyUsage: '',
                    orderDate: '',
                    deliveryDate: '',
                    estimatedCompletionDate: '',
                    status: 'future'
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const submitData = {...formData};
                    if (!submitData.remainingQuantity) {
                        submitData.remainingQuantity = submitData.totalQuantity;
                    }
                    onSubmit(submitData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">
                                    {initialData ? 'Edit Contract' : 'Add New Contract'}
                                </h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Material</label>
                                            <select
                                                value={formData.material}
                                                onChange={(e) => setFormData({...formData, material: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            >
                                                <option value="aluminum5052">Aluminum 5052</option>
                                                <option value="stainless304">Stainless Steel 304 2B</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Contract Status</label>
                                            <select
                                                value={formData.status}
                                                onChange={(e) => setFormData({...formData, status: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            >
                                                <option value="future">Future (Ordered, Not Received)</option>
                                                <option value="active">Active (Received, In Use)</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Vendor</label>
                                        <input
                                            type="text"
                                            value={formData.vendor}
                                            onChange={(e) => setFormData({...formData, vendor: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Price per Pound ($)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.pricePerLb}
                                                onChange={(e) => setFormData({...formData, pricePerLb: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">Total Quantity (lbs)</label>
                                            <input
                                                type="number"
                                                value={formData.totalQuantity}
                                                onChange={(e) => setFormData({...formData, totalQuantity: e.target.value, remainingQuantity: formData.remainingQuantity || e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>
                                    </div>

                                    {formData.status === 'active' && (
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Remaining Quantity (lbs)</label>
                                            <input
                                                type="number"
                                                value={formData.remainingQuantity}
                                                onChange={(e) => setFormData({...formData, remainingQuantity: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Update this as material is consumed from the contract</p>
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Average Monthly Usage (lbs)</label>
                                        <input
                                            type="number"
                                            value={formData.avgMonthlyUsage}
                                            onChange={(e) => setFormData({...formData, avgMonthlyUsage: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Order Date</label>
                                            <input
                                                type="date"
                                                value={formData.orderDate}
                                                onChange={(e) => setFormData({...formData, orderDate: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">Expected Delivery Date</label>
                                            <input
                                                type="date"
                                                value={formData.deliveryDate}
                                                onChange={(e) => setFormData({...formData, deliveryDate: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Estimated Completion Date</label>
                                        <input
                                            type="date"
                                            value={formData.estimatedCompletionDate}
                                            onChange={(e) => setFormData({...formData, estimatedCompletionDate: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">When you expect this contract to be fully consumed</p>
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            {initialData ? 'Update Contract' : 'Add Contract'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const UsageForm = ({ onClose, onSubmit, initialData = null }) => {
                const [formData, setFormData] = useState(initialData || {
                    id: Date.now(),
                    month: new Date().toISOString().substring(0, 7), // YYYY-MM format
                    material: 'aluminum5052',
                    quantity: '',
                    notes: ''
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">{initialData ? 'Edit Monthly Usage' : 'Log Monthly Usage'}</h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Month</label>
                                        <input
                                            type="month"
                                            value={formData.month}
                                            onChange={(e) => setFormData({...formData, month: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Material</label>
                                        <select
                                            value={formData.material}
                                            onChange={(e) => setFormData({...formData, material: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        >
                                            <option value="aluminum5052">Aluminum 5052</option>
                                            <option value="stainless304">Stainless Steel 304 2B</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Quantity Used (lbs)</label>
                                        <input
                                            type="number"
                                            value={formData.quantity}
                                            onChange={(e) => setFormData({...formData, quantity: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Notes (Optional)</label>
                                        <textarea
                                            value={formData.notes}
                                            onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            rows="2"
                                        />
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            {initialData ? 'Update Usage' : 'Log Usage'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const InventoryForm = ({ onClose, onSubmit, currentInventory }) => {
                const [formData, setFormData] = useState({
                    aluminum5052: currentInventory.aluminum5052.quantity,
                    stainless304: currentInventory.stainless304.quantity
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">Update Inventory Levels</h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Aluminum 5052 Stock (lbs)</label>
                                        <input
                                            type="number"
                                            value={formData.aluminum5052}
                                            onChange={(e) => setFormData({...formData, aluminum5052: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Stainless Steel 304 2B Stock (lbs)</label>
                                        <input
                                            type="number"
                                            value={formData.stainless304}
                                            onChange={(e) => setFormData({...formData, stainless304: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            Update Inventory
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const MarketPriceForm = ({ onClose, onSubmit, initialData = null }) => {
                const [formData, setFormData] = useState(initialData || {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    lmeAluminum: '',
                    aluminumBase: '',
                    midwestPremium: '',
                    nickel: '',
                    chrome: '',
                    molybdenum: '',
                    scrapIron: '',
                    conversionPricing: '',
                    nasStainlessSurcharge: '',
                    outokumpuSurcharge: '',
                    notes: ''
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">{initialData ? 'Edit Market Prices' : 'Enter Market Prices'}</h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Date</label>
                                        <input
                                            type="date"
                                            value={formData.date}
                                            onChange={(e) => setFormData({...formData, date: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="border-t pt-4">
                                        <h3 className="font-semibold mb-3 text-lg">Aluminum Pricing</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">LME Aluminum ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.lmeAluminum}
                                                    onChange={(e) => setFormData({...formData, lmeAluminum: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Aluminum Base ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.aluminumBase}
                                                    onChange={(e) => setFormData({...formData, aluminumBase: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Midwest Premium ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.midwestPremium}
                                                    onChange={(e) => setFormData({...formData, midwestPremium: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border-t pt-4">
                                        <h3 className="font-semibold mb-3 text-lg">Stainless Steel Components</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Nickel ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.nickel}
                                                    onChange={(e) => setFormData({...formData, nickel: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Chrome ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.chrome}
                                                    onChange={(e) => setFormData({...formData, chrome: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Molybdenum ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.molybdenum}
                                                    onChange={(e) => setFormData({...formData, molybdenum: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Scrap Iron ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.scrapIron}
                                                    onChange={(e) => setFormData({...formData, scrapIron: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Conversion Pricing ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.conversionPricing}
                                                    onChange={(e) => setFormData({...formData, conversionPricing: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border-t pt-4">
                                        <h3 className="font-semibold mb-3 text-lg">Stainless Surcharges</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">North American Stainless ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.nasStainlessSurcharge}
                                                    onChange={(e) => setFormData({...formData, nasStainlessSurcharge: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Outokumpu ($/lb)</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.outokumpuSurcharge}
                                                    onChange={(e) => setFormData({...formData, outokumpuSurcharge: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Notes (Optional)</label>
                                        <textarea
                                            value={formData.notes}
                                            onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            rows="2"
                                        />
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            {initialData ? 'Update Prices' : 'Save Prices'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const addContract = (contract) => {
                setContracts([...contracts, contract]);
            };

            const updateContract = (updatedContract) => {
                setContracts(contracts.map(c => c.id === updatedContract.id ? updatedContract : c));
            };

            const addUsage = (usage) => {
                setUsageHistory([...usageHistory, usage].sort((a, b) => b.month.localeCompare(a.month)));
                
                // Update inventory (reduce stock by usage amount)
                const newInventory = {...inventory};
                newInventory[usage.material].quantity -= parseFloat(usage.quantity);
                setInventory(newInventory);
                
                // Note: Contract remaining quantities are managed separately through contract editing
            };

            const updateUsage = (updatedUsage) => {
                // Find the old usage to adjust inventory back
                const oldUsage = usageHistory.find(u => u.id === updatedUsage.id);
                if (oldUsage) {
                    // Add back the old quantity, subtract the new quantity
                    const newInventory = {...inventory};
                    newInventory[oldUsage.material].quantity += parseFloat(oldUsage.quantity);
                    newInventory[updatedUsage.material].quantity -= parseFloat(updatedUsage.quantity);
                    setInventory(newInventory);
                }
                
                setUsageHistory(usageHistory.map(u => u.id === updatedUsage.id ? updatedUsage : u).sort((a, b) => b.month.localeCompare(a.month)));
            };

            const addMarketPrice = (price) => {
                setMarketPrices([...marketPrices, price].sort((a, b) => new Date(b.date) - new Date(a.date)));
            };

            const updateMarketPrice = (updatedPrice) => {
                setMarketPrices(marketPrices.map(p => p.id === updatedPrice.id ? updatedPrice : p).sort((a, b) => new Date(b.date) - new Date(a.date)));
            };

            const updateInventory = (newInventory) => {
                setInventory({
                    aluminum5052: { quantity: parseFloat(newInventory.aluminum5052), unit: 'lbs' },
                    stainless304: { quantity: parseFloat(newInventory.stainless304), unit: 'lbs' }
                });
            };

            const getLatestMarketPrice = () => {
                return marketPrices.length > 0 ? marketPrices[0] : null;
            };

            const calculateMarketPrice = (material) => {
                const latest = getLatestMarketPrice();
                if (!latest) return null;

                if (material === 'aluminum5052') {
                    // Return Base + Midwest as the market total, plus individual values
                    const base = parseFloat(latest.aluminumBase) || 0;
                    const midwest = parseFloat(latest.midwestPremium) || 0;
                    const lme = parseFloat(latest.lmeAluminum) || 0;
                    return {
                        lme: lme,
                        base: base,
                        midwest: midwest,
                        total: base + midwest
                    };
                } else if (material === 'stainless304') {
                    // Calculate: Nickel + Chrome + Scrap Iron + Conversion
                    const ni = parseFloat(latest.nickel) || 0;
                    const cr = parseFloat(latest.chrome) || 0;
                    const scrap = parseFloat(latest.scrapIron) || 0;
                    const conversion = parseFloat(latest.conversionPricing) || 0;
                    
                    return ni + cr + scrap + conversion;
                }
                return null;
            };

            const Dashboard = () => {
                const futureContracts = contracts.filter(c => c.status === 'future');
                const alContracts = contracts.filter(c => c.material === 'aluminum5052' && c.status === 'active');
                const ssContracts = contracts.filter(c => c.material === 'stainless304' && c.status === 'active');
                
                const alMarketPrice = calculateMarketPrice('aluminum5052');
                const ssMarketPrice = calculateMarketPrice('stainless304');

                // Calculate average monthly usage for projections
                const calculateAverageUsage = (material) => {
                    const materialUsage = usageHistory.filter(u => u.material === material);
                    if (materialUsage.length === 0) return 0;
                    const total = materialUsage.reduce((sum, u) => sum + parseFloat(u.quantity), 0);
                    return total / materialUsage.length;
                };

                const alAvgMonthlyUsage = calculateAverageUsage('aluminum5052');
                const ssAvgMonthlyUsage = calculateAverageUsage('stainless304');

                // Calculate days remaining based on usage rate
                const calculateDaysRemaining = (remainingQty, avgMonthlyUsage) => {
                    if (avgMonthlyUsage === 0) return null;
                    const monthsRemaining = remainingQty / avgMonthlyUsage;
                    return Math.ceil(monthsRemaining * 30); // Convert months to days
                };

                const usageByMonth = {};
                usageHistory.forEach(u => {
                    const month = u.month; // Already in YYYY-MM format
                    if (!usageByMonth[month]) {
                        usageByMonth[month] = { aluminum5052: 0, stainless304: 0 };
                    }
                    usageByMonth[month][u.material] += parseFloat(u.quantity);
                });

                const usageChartData = Object.keys(usageByMonth).sort().slice(-6).map(month => ({
                    month,
                    Aluminum: Math.round(usageByMonth[month].aluminum5052),
                    Stainless: Math.round(usageByMonth[month].stainless304)
                }));

                const priceChartData = marketPrices.slice(0, 10).reverse().map(p => ({
                    date: p.date,
                    'Al Market': parseFloat(p.lmeAluminum || 0) + parseFloat(p.midwestPremium || 0),
                    'SS Market': parseFloat(p.nasStainlessSurcharge || 0) || parseFloat(p.outokumpuSurcharge || 0)
                }));

                return (
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600">Active Contracts</p>
                                        <p className="text-3xl font-bold">{contracts.filter(c => c.status === 'active').length}</p>
                                    </div>
                                    <FileText size={32} className="text-blue-600" />
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600">Future Contracts</p>
                                        <p className="text-3xl font-bold">{futureContracts.length}</p>
                                    </div>
                                    <Clock size={32} className="text-orange-600" />
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600">Al 5052 Stock</p>
                                        <p className="text-3xl font-bold">{inventory.aluminum5052.quantity.toLocaleString()}</p>
                                        <p className="text-xs text-gray-500">lbs</p>
                                    </div>
                                    <Package size={32} className="text-green-600" />
                                </div>
                                <button
                                    onClick={() => setShowInventoryForm(true)}
                                    className="mt-3 text-xs text-blue-600 hover:text-blue-800"
                                >
                                    Update Stock Levels
                                </button>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600">SS 304 Stock</p>
                                        <p className="text-3xl font-bold">{inventory.stainless304.quantity.toLocaleString()}</p>
                                        <p className="text-xs text-gray-500">lbs</p>
                                    </div>
                                    <Package size={32} className="text-purple-600" />
                                </div>
                            </div>
                        </div>

                        {futureContracts.length > 0 && (
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <Clock size={20} />
                                    Future Contracts (Ordered, Awaiting Delivery)
                                </h3>
                                <div className="space-y-3">
                                    {futureContracts.map(c => {
                                        const daysUntilDelivery = Math.ceil((new Date(c.deliveryDate) - new Date()) / (1000 * 60 * 60 * 24));
                                        const isOverdue = daysUntilDelivery < 0;
                                        
                                        // Calculate projected end date for this future contract
                                        const avgUsage = c.material === 'aluminum5052' ? alAvgMonthlyUsage : ssAvgMonthlyUsage;
                                        const activeContract = contracts.find(contract => 
                                            contract.material === c.material && contract.status === 'active'
                                        );
                                        
                                        let projectedEndDate = null;
                                        let projectedStartDate = null;
                                        
                                        if (avgUsage > 0) {
                                            // Use active contract remaining quantity (which IS the current stock)
                                            let runningTotal = 0;
                                            if (activeContract) {
                                                runningTotal = parseFloat(activeContract.remainingQuantity || 0);
                                            }
                                            
                                            // Active contract depletes, then this future contract starts
                                            const monthsUntilStart = runningTotal / avgUsage;
                                            projectedStartDate = new Date();
                                            projectedStartDate.setMonth(projectedStartDate.getMonth() + monthsUntilStart);
                                            
                                            // Add this contract's quantity
                                            const futureQty = parseFloat(c.totalQuantity);
                                            runningTotal += futureQty;
                                            const monthsUntilEnd = runningTotal / avgUsage;
                                            projectedEndDate = new Date();
                                            projectedEndDate.setMonth(projectedEndDate.getMonth() + monthsUntilEnd);
                                        }
                                        
                                        return (
                                            <div key={c.id} className="border rounded p-3 bg-orange-50">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="font-semibold">{c.vendor}</span>
                                                            <span className="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded">
                                                                {c.material === 'aluminum5052' ? 'Aluminum 5052' : 'Stainless 304 2B'}
                                                            </span>
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            <span className="font-medium">${c.pricePerLb}/lb</span>
                                                            <span className="mx-2">•</span>
                                                            <span>{parseFloat(c.totalQuantity).toLocaleString()} lbs</span>
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            Ordered: {c.orderDate}
                                                        </div>
                                                        {projectedStartDate && projectedEndDate && (
                                                            <div className="text-xs mt-2 pt-2 border-t border-orange-200">
                                                                <div className="font-medium text-orange-700">Projected Timeline:</div>
                                                                <div className="text-gray-600">
                                                                    Start using: ~{projectedStartDate.toISOString().substring(0, 7)}
                                                                </div>
                                                                <div className="text-gray-600">
                                                                    Est. depleted: ~{projectedEndDate.toISOString().substring(0, 7)}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {avgUsage === 0 && (
                                                            <div className="text-xs mt-2 pt-2 border-t border-orange-200 text-gray-500">
                                                                Log usage data to see projections
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="text-right">
                                                        <div className={`text-sm font-semibold ${isOverdue ? 'text-red-600' : 'text-orange-600'}`}>
                                                            {isOverdue ? 'OVERDUE' : `${daysUntilDelivery} days`}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            Delivery: {c.deliveryDate}
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                setEditingContract(c);
                                                                setShowContractForm(true);
                                                            }}
                                                            className="text-xs text-blue-600 hover:text-blue-800 mt-1"
                                                        >
                                                            Mark as Received
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4">Aluminum 5052 - Active Contracts</h3>
                                {alContracts.length > 0 ? (
                                    <div className="space-y-3">
                                        {alContracts.map(c => {
                                            const remainingQty = parseFloat(c.remainingQuantity);
                                            const daysRemaining = calculateDaysRemaining(remainingQty, alAvgMonthlyUsage);
                                            const percentRemaining = (remainingQty / parseFloat(c.totalQuantity)) * 100;
                                            
                                            return (
                                                <div key={c.id} className="border rounded p-3">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <p className="font-semibold">{c.vendor}</p>
                                                            <p className="text-sm text-gray-600">${c.pricePerLb}/lb</p>
                                                        </div>
                                                        {alMarketPrice && (
                                                            <div className="text-right">
                                                                <p className="text-xs text-gray-500">vs Market</p>
                                                                <p className={`text-sm font-semibold ${parseFloat(c.pricePerLb) < alMarketPrice.total ? 'text-green-600' : 'text-red-600'}`}>
                                                                    {parseFloat(c.pricePerLb) < alMarketPrice.total ? '↓' : '↑'} ${Math.abs(alMarketPrice.total - parseFloat(c.pricePerLb)).toFixed(4)}
                                                                </p>
                                                                <p className="text-xs text-gray-500">Mkt: ${alMarketPrice.total.toFixed(4)}</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-2 mb-1">
                                                        <div className="bg-blue-600 h-2 rounded-full" style={{width: `${percentRemaining}%`}}></div>
                                                    </div>
                                                    <div className="flex justify-between text-xs text-gray-600">
                                                        <span>{remainingQty.toLocaleString()} lbs on contract</span>
                                                        <span>
                                                            {daysRemaining !== null ? (
                                                                daysRemaining > 0 ? `~${daysRemaining} days` : 'Depleted'
                                                            ) : (
                                                                'No usage data'
                                                            )}
                                                        </span>
                                                    </div>
                                                    <div className="text-xs font-semibold text-green-700 mt-1">
                                                        Current Stock: {inventory.aluminum5052.quantity.toLocaleString()} lbs
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <p className="text-gray-500 text-center py-8">No active aluminum contracts</p>
                                )}
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4">Stainless 304 2B - Active Contracts</h3>
                                {ssContracts.length > 0 ? (
                                    <div className="space-y-3">
                                        {ssContracts.map(c => {
                                            const remainingQty = parseFloat(c.remainingQuantity);
                                            const daysRemaining = calculateDaysRemaining(remainingQty, ssAvgMonthlyUsage);
                                            const percentRemaining = (remainingQty / parseFloat(c.totalQuantity)) * 100;
                                            
                                            return (
                                                <div key={c.id} className="border rounded p-3">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <p className="font-semibold">{c.vendor}</p>
                                                            <p className="text-sm text-gray-600">${c.pricePerLb}/lb</p>
                                                        </div>
                                                        {ssMarketPrice && (
                                                            <div className="text-right">
                                                                <p className="text-xs text-gray-500">vs Market</p>
                                                                <p className={`text-sm font-semibold ${parseFloat(c.pricePerLb) < ssMarketPrice ? 'text-green-600' : 'text-red-600'}`}>
                                                                    {parseFloat(c.pricePerLb) < ssMarketPrice ? '↓' : '↑'} ${Math.abs(ssMarketPrice - parseFloat(c.pricePerLb)).toFixed(4)}
                                                                </p>
                                                                <p className="text-xs text-gray-500">Mkt: ${ssMarketPrice.toFixed(4)}</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-2 mb-1">
                                                        <div className="bg-purple-600 h-2 rounded-full" style={{width: `${percentRemaining}%`}}></div>
                                                    </div>
                                                    <div className="flex justify-between text-xs text-gray-600">
                                                        <span>{remainingQty.toLocaleString()} lbs on contract</span>
                                                        <span>
                                                            {daysRemaining !== null ? (
                                                                daysRemaining > 0 ? `~${daysRemaining} days` : 'Depleted'
                                                            ) : (
                                                                'No usage data'
                                                            )}
                                                        </span>
                                                    </div>
                                                    <div className="text-xs font-semibold text-purple-700 mt-1">
                                                        Current Stock: {inventory.stainless304.quantity.toLocaleString()} lbs
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <p className="text-gray-500 text-center py-8">No active stainless contracts</p>
                                )}
                            </div>
                        </div>

                        {usageChartData.length > 0 && typeof ResponsiveContainer !== 'undefined' && (
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4">Monthly Usage Trend</h3>
                                <ResponsiveContainer width="100%" height={300}>
                                    <BarChart data={usageChartData}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis dataKey="month" />
                                        <YAxis />
                                        <Tooltip />
                                        <Legend />
                                        <Bar dataKey="Aluminum" fill="#3b82f6" />
                                        <Bar dataKey="Stainless" fill="#a855f7" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        )}

                        {priceChartData.length > 0 && typeof ResponsiveContainer !== 'undefined' && (
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4">Market Price Trends</h3>
                                <ResponsiveContainer width="100%" height={300}>
                                    <LineChart data={priceChartData}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis dataKey="date" />
                                        <YAxis />
                                        <Tooltip />
                                        <Legend />
                                        <Line type="monotone" dataKey="Al Market" stroke="#3b82f6" strokeWidth={2} />
                                        <Line type="monotone" dataKey="SS Market" stroke="#a855f7" strokeWidth={2} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        )}
                    </div>
                );
            };

            const ContractsView = () => {
                return (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Contracts</h2>
                            <button
                                onClick={() => {
                                    setEditingContract(null);
                                    setShowContractForm(true);
                                }}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                <Plus size={20} />
                                Add Contract
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Material</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price/lb</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Delivery</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {contracts.map(contract => (
                                        <tr key={contract.id}>
                                            <td className="px-6 py-4">
                                                {contract.material === 'aluminum5052' ? 'Aluminum 5052' : 'Stainless 304 2B'}
                                            </td>
                                            <td className="px-6 py-4">{contract.vendor}</td>
                                            <td className="px-6 py-4">${contract.pricePerLb}</td>
                                            <td className="px-6 py-4">
                                                {contract.status === 'active' 
                                                    ? `${parseFloat(contract.remainingQuantity).toLocaleString()} / ${parseFloat(contract.totalQuantity).toLocaleString()} lbs`
                                                    : `${parseFloat(contract.totalQuantity).toLocaleString()} lbs`
                                                }
                                            </td>
                                            <td className="px-6 py-4">{contract.deliveryDate}</td>
                                            <td className="px-6 py-4">
                                                <span className={`px-2 py-1 rounded text-xs ${
                                                    contract.status === 'active' ? 'bg-green-100 text-green-800' : 
                                                    contract.status === 'future' ? 'bg-orange-100 text-orange-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`}>
                                                    {contract.status}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4">
                                                <button
                                                    onClick={() => {
                                                        setEditingContract(contract);
                                                        setShowContractForm(true);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-800 text-sm"
                                                >
                                                    Edit
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {contracts.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    No contracts yet. Click "Add Contract" to get started.
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const UsageView = () => {
                // Calculate average monthly usage for each material
                const calculateAverageUsage = (material) => {
                    const materialUsage = usageHistory.filter(u => u.material === material);
                    if (materialUsage.length === 0) return 0;
                    const total = materialUsage.reduce((sum, u) => sum + parseFloat(u.quantity), 0);
                    return total / materialUsage.length;
                };

                const alAvgUsage = calculateAverageUsage('aluminum5052');
                const ssAvgUsage = calculateAverageUsage('stainless304');

                // Calculate projected contract end dates
                const calculateContractProjections = (material) => {
                    const avgUsage = material === 'aluminum5052' ? alAvgUsage : ssAvgUsage;
                    if (avgUsage === 0) return [];

                    const currentStock = material === 'aluminum5052' ? inventory.aluminum5052.quantity : inventory.stainless304.quantity;
                    const allContracts = contracts
                        .filter(c => c.material === material && (c.status === 'active' || c.status === 'future'))
                        .sort((a, b) => {
                            // Sort: active first, then by delivery date
                            if (a.status === 'active' && b.status !== 'active') return -1;
                            if (a.status !== 'active' && b.status === 'active') return 1;
                            return new Date(a.deliveryDate) - new Date(b.deliveryDate);
                        });

                    let runningTotal = currentStock;
                    const projections = [];

                    allContracts.forEach(contract => {
                        const contractQty = parseFloat(contract.remainingQuantity || contract.totalQuantity);
                        runningTotal += contractQty;
                        const monthsUntilEnd = runningTotal / avgUsage;
                        const endDate = new Date();
                        endDate.setMonth(endDate.getMonth() + monthsUntilEnd);
                        
                        projections.push({
                            vendor: contract.vendor,
                            status: contract.status,
                            quantity: contractQty,
                            projectedEndDate: endDate.toISOString().substring(0, 7), // YYYY-MM
                            monthsFromNow: Math.ceil(monthsUntilEnd)
                        });
                    });

                    return projections;
                };

                const alProjections = calculateContractProjections('aluminum5052');
                const ssProjections = calculateContractProjections('stainless304');

                return (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Monthly Usage History</h2>
                            <button
                                onClick={() => {
                                    setEditingUsage(null);
                                    setShowUsageForm(true);
                                }}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                <Plus size={20} />
                                Log Monthly Usage
                            </button>
                        </div>

                        {/* Usage Statistics */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h3 className="font-semibold text-blue-900 mb-2">Aluminum 5052 Average Usage</h3>
                                <p className="text-2xl font-bold text-blue-700">{alAvgUsage.toLocaleString(undefined, {maximumFractionDigits: 0})} lbs/month</p>
                                <p className="text-xs text-blue-600 mt-1">Based on {usageHistory.filter(u => u.material === 'aluminum5052').length} months of data</p>
                            </div>
                            <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <h3 className="font-semibold text-purple-900 mb-2">Stainless 304 2B Average Usage</h3>
                                <p className="text-2xl font-bold text-purple-700">{ssAvgUsage.toLocaleString(undefined, {maximumFractionDigits: 0})} lbs/month</p>
                                <p className="text-xs text-purple-600 mt-1">Based on {usageHistory.filter(u => u.material === 'stainless304').length} months of data</p>
                            </div>
                        </div>

                        {/* Contract Projections */}
                        {(alProjections.length > 0 || ssProjections.length > 0) && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {alProjections.length > 0 && (
                                    <div className="bg-white p-4 rounded-lg shadow">
                                        <h3 className="font-semibold mb-3">Aluminum Contract Projections</h3>
                                        <div className="space-y-2">
                                            {alProjections.map((proj, idx) => (
                                                <div key={idx} className="text-sm border-l-4 border-blue-500 pl-3 py-1">
                                                    <div className="font-medium">{proj.vendor} {proj.status === 'future' && '(Future)'}</div>
                                                    <div className="text-gray-600">
                                                        {proj.quantity.toLocaleString()} lbs → Est. end: <span className="font-semibold">{proj.projectedEndDate}</span>
                                                    </div>
                                                    <div className="text-xs text-gray-500">~{proj.monthsFromNow} months from now</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {ssProjections.length > 0 && (
                                    <div className="bg-white p-4 rounded-lg shadow">
                                        <h3 className="font-semibold mb-3">Stainless Contract Projections</h3>
                                        <div className="space-y-2">
                                            {ssProjections.map((proj, idx) => (
                                                <div key={idx} className="text-sm border-l-4 border-purple-500 pl-3 py-1">
                                                    <div className="font-medium">{proj.vendor} {proj.status === 'future' && '(Future)'}</div>
                                                    <div className="text-gray-600">
                                                        {proj.quantity.toLocaleString()} lbs → Est. end: <span className="font-semibold">{proj.projectedEndDate}</span>
                                                    </div>
                                                    <div className="text-xs text-gray-500">~{proj.monthsFromNow} months from now</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Usage History Table */}
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Material</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {usageHistory.map(usage => (
                                        <tr key={usage.id}>
                                            <td className="px-6 py-4">{usage.month}</td>
                                            <td className="px-6 py-4">
                                                {usage.material === 'aluminum5052' ? 'Aluminum 5052' : 'Stainless 304 2B'}
                                            </td>
                                            <td className="px-6 py-4">{parseFloat(usage.quantity).toLocaleString()} lbs</td>
                                            <td className="px-6 py-4 text-sm text-gray-600">{usage.notes || '-'}</td>
                                            <td className="px-6 py-4">
                                                <button
                                                    onClick={() => {
                                                        setEditingUsage(usage);
                                                        setShowUsageForm(true);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-800 text-sm"
                                                >
                                                    Edit
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {usageHistory.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    No usage recorded yet. Click "Log Monthly Usage" to get started.
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const MarketPricesView = () => {
                const latest = getLatestMarketPrice();
                
                return (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Market Prices</h2>
                            <button
                                onClick={() => {
                                    setEditingMarketPrice(null);
                                    setShowMarketPriceForm(true);
                                }}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                <Plus size={20} />
                                Enter Prices
                            </button>
                        </div>

                        {latest && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-lg font-semibold mb-4">Latest Aluminum Pricing</h3>
                                    <div className="space-y-3">
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">LME Aluminum:</span>
                                            <span className="font-semibold">${latest.lmeAluminum || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">Aluminum Base:</span>
                                            <span className="font-semibold">${latest.aluminumBase || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">Midwest Premium:</span>
                                            <span className="font-semibold">${latest.midwestPremium || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t">
                                            <span className="font-semibold text-blue-700">Market Total (Base+MW):</span>
                                            <span className="font-bold text-blue-700">
                                                ${calculateMarketPrice('aluminum5052')?.total.toFixed(4) || '-'}/lb
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-500 text-right pt-2">
                                            Updated: {latest.date}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-lg font-semibold mb-4">Latest Stainless Pricing</h3>
                                    <div className="space-y-3">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Nickel:</span>
                                            <span className="font-semibold">${latest.nickel || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Chrome:</span>
                                            <span className="font-semibold">${latest.chrome || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Molybdenum:</span>
                                            <span className="font-semibold">${latest.molybdenum || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Scrap Iron:</span>
                                            <span className="font-semibold">${latest.scrapIron || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Conversion Pricing:</span>
                                            <span className="font-semibold">${latest.conversionPricing || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm pt-2 border-t">
                                            <span className="text-gray-600">NAS Surcharge:</span>
                                            <span className="font-semibold">${latest.nasStainlessSurcharge || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Outokumpu Surcharge:</span>
                                            <span className="font-semibold">${latest.outokumpuSurcharge || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t">
                                            <span className="font-semibold text-purple-700">Market Total (Ni+Cr+Scrap+Conv):</span>
                                            <span className="font-bold text-purple-700">
                                                ${calculateMarketPrice('stainless304')?.toFixed(4) || '-'}/lb
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-500 text-right pt-2">
                                            Updated: {latest.date}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="px-6 py-4 bg-gray-50 border-b">
                                <h3 className="font-semibold">Price History</h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">LME Al</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Al Base</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">MW Prem</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nickel</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Conversion</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NAS Surch</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {marketPrices.map(price => (
                                            <tr key={price.id}>
                                                <td className="px-6 py-4">{price.date}</td>
                                                <td className="px-6 py-4">${price.lmeAluminum || '-'}</td>
                                                <td className="px-6 py-4">${price.aluminumBase || '-'}</td>
                                                <td className="px-6 py-4">${price.midwestPremium || '-'}</td>
                                                <td className="px-6 py-4">${price.nickel || '-'}</td>
                                                <td className="px-6 py-4">${price.conversionPricing || '-'}</td>
                                                <td className="px-6 py-4">${price.nasStainlessSurcharge || '-'}</td>
                                                <td className="px-6 py-4 text-sm text-gray-600">{price.notes || '-'}</td>
                                                <td className="px-6 py-4">
                                                    <button
                                                        onClick={() => {
                                                            setEditingMarketPrice(price);
                                                            setShowMarketPriceForm(true);
                                                        }}
                                                        className="text-blue-600 hover:text-blue-800 text-sm"
                                                    >
                                                        Edit
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            {marketPrices.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    No market prices recorded yet. Click "Enter Prices" to get started.
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <div className="bg-blue-600 text-white p-4 shadow-lg">
                        <div className="max-w-7xl mx-auto">
                            <h1 className="text-2xl font-bold">Materials Management System</h1>
                            <p className="text-sm text-blue-100">Sheet Metal Procurement & Contract Tracking</p>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-4">
                        <div className="bg-white rounded-lg shadow mb-6">
                            <div className="flex border-b">
                                <button
                                    onClick={() => setActiveTab('dashboard')}
                                    className={`px-6 py-3 font-medium ${
                                        activeTab === 'dashboard'
                                            ? 'border-b-2 border-blue-600 text-blue-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Dashboard
                                </button>
                                <button
                                    onClick={() => setActiveTab('contracts')}
                                    className={`px-6 py-3 font-medium ${
                                        activeTab === 'contracts'
                                            ? 'border-b-2 border-blue-600 text-blue-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Contracts
                                </button>
                                <button
                                    onClick={() => setActiveTab('usage')}
                                    className={`px-6 py-3 font-medium ${
                                        activeTab === 'usage'
                                            ? 'border-b-2 border-blue-600 text-blue-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Usage History
                                </button>
                                <button
                                    onClick={() => setActiveTab('market')}
                                    className={`px-6 py-3 font-medium ${
                                        activeTab === 'market'
                                            ? 'border-b-2 border-blue-600 text-blue-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Market Prices
                                </button>
                            </div>
                        </div>

                        {activeTab === 'dashboard' && <Dashboard />}
                        {activeTab === 'contracts' && <ContractsView />}
                        {activeTab === 'usage' && <UsageView />}
                        {activeTab === 'market' && <MarketPricesView />}
                    </div>

                    {showContractForm && (
                        <ContractForm
                            onClose={() => {
                                setShowContractForm(false);
                                setEditingContract(null);
                            }}
                            onSubmit={editingContract ? updateContract : addContract}
                            initialData={editingContract}
                        />
                    )}

                    {showUsageForm && (
                        <UsageForm
                            onClose={() => {
                                setShowUsageForm(false);
                                setEditingUsage(null);
                            }}
                            onSubmit={editingUsage ? updateUsage : addUsage}
                            initialData={editingUsage}
                        />
                    )}

                    {showMarketPriceForm && (
                        <MarketPriceForm
                            onClose={() => {
                                setShowMarketPriceForm(false);
                                setEditingMarketPrice(null);
                            }}
                            onSubmit={editingMarketPrice ? updateMarketPrice : addMarketPrice}
                            initialData={editingMarketPrice}
                        />
                    )}

                    {showInventoryForm && (
                        <InventoryForm
                            onClose={() => setShowInventoryForm(false)}
                            onSubmit={updateInventory}
                            currentInventory={inventory}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MaterialsManagement />);
    </script>
</body>
</html>
