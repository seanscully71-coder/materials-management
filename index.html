<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materials Management System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.1.16/umd/Recharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif;">
            <div style="text-align: center;">
                <div class="loader"></div>
                <p style="color: #666;">Loading Materials Management System...</p>
                <p id="status" style="color: #999; font-size: 12px; margin-top: 10px;">Initializing...</p>
            </div>
        </div>
    </div>

    <script>
        // Diagnostic function
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.textContent = message;
            console.log('Status:', message);
        }

        // Check library loading with timeout
        let checkCount = 0;
        const maxChecks = 50; // 5 seconds max
        
        function checkLibraries() {
            checkCount++;
            updateStatus(`Checking libraries... (${checkCount}/${maxChecks})`);
            
            const reactLoaded = typeof React !== 'undefined';
            const reactDomLoaded = typeof ReactDOM !== 'undefined';
            const babelLoaded = typeof Babel !== 'undefined';
            const rechartsLoaded = typeof Recharts !== 'undefined' || typeof window.Recharts !== 'undefined';
            
            console.log('Library status:', {
                React: reactLoaded,
                ReactDOM: reactDomLoaded,
                Babel: babelLoaded,
                Recharts: rechartsLoaded
            });
            
            // Wait for Recharts too, but make it optional
            if (reactLoaded && reactDomLoaded && babelLoaded) {
                if (!rechartsLoaded) {
                    console.warn('Recharts failed to load - charts will be disabled but app will still work');
                }
                updateStatus('Libraries loaded! Starting app...');
                setTimeout(initializeApp, 500);
                return;
            }
            
            if (checkCount >= maxChecks) {
                document.getElementById('root').innerHTML = `
                    <div style="padding: 40px; font-family: sans-serif; max-width: 600px; margin: 0 auto;">
                        <h1 style="color: #dc2626;">Loading Error</h1>
                        <p>Some required libraries failed to load. This might be due to:</p>
                        <ul style="line-height: 1.8;">
                            <li>Internet connection issues</li>
                            <li>Corporate firewall blocking CDN libraries</li>
                            <li>Ad blocker interference</li>
                            <li>Browser security settings</li>
                        </ul>
                        <h3>What loaded:</h3>
                        <ul>
                            <li>React: ${reactLoaded ? 'âœ“' : 'âœ— REQUIRED'}</li>
                            <li>ReactDOM: ${reactDomLoaded ? 'âœ“' : 'âœ— REQUIRED'}</li>
                            <li>Babel: ${babelLoaded ? 'âœ“' : 'âœ— REQUIRED'}</li>
                            <li>Recharts: ${rechartsLoaded ? 'âœ“' : 'âœ— (optional - charts disabled)'}</li>
                        </ul>
                        <h3>Try this:</h3>
                        <ol style="line-height: 1.8;">
                            <li>Refresh the page (Ctrl+Shift+R)</li>
                            <li>Disable ad blockers</li>
                            <li>Try a different browser</li>
                            <li>Download and open the file locally</li>
                        </ol>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
                return;
            }
            
            setTimeout(checkLibraries, 100);
        }
        
        function initializeApp() {
            try {
                updateStatus('Compiling application...');
                console.log('App initialization started');
                
                // Set a timeout to detect if compilation hangs
                setTimeout(() => {
                    const root = document.getElementById('root');
                    // If still showing loading after 10 seconds, something went wrong
                    if (root.innerHTML.includes('Loading Materials Management System')) {
                        console.error('Compilation timeout - Babel may have failed');
                        root.innerHTML = `
                            <div style="padding: 40px; font-family: sans-serif; max-width: 600px; margin: 0 auto;">
                                <h1 style="color: #dc2626;">Compilation Timeout</h1>
                                <p>The application failed to compile within 10 seconds. This usually means:</p>
                                <ul style="line-height: 1.8;">
                                    <li>Babel (the JavaScript compiler) encountered an error</li>
                                    <li>Your browser may not support the required features</li>
                                    <li>A browser extension is interfering</li>
                                </ul>
                                <h3>Try these solutions:</h3>
                                <ol style="line-height: 1.8;">
                                    <li><strong>Open the browser console</strong> (F12) to see detailed errors</li>
                                    <li><strong>Try a different browser</strong> (Chrome, Firefox, or Edge recommended)</li>
                                    <li><strong>Disable browser extensions</strong> temporarily</li>
                                    <li><strong>Download and open locally</strong> instead of using GitHub Pages</li>
                                </ol>
                                <div style="margin-top: 20px;">
                                    <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                        Try Again
                                    </button>
                                    <button onclick="window.open('https://app.netlify.com/drop', '_blank')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                        Try Netlify Instead
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }, 10000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('root').innerHTML = `
                    <div style="padding: 40px; font-family: sans-serif;">
                        <h1 style="color: #dc2626;">Initialization Error</h1>
                        <p>Error: ${error.message}</p>
                        <pre style="background: #f3f4f6; padding: 15px; border-radius: 5px; overflow-x: auto;">${error.stack}</pre>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Reload Page
                        </button>
                    </div>
                `;
            }
        }
        
        // Start checking after a brief delay to let scripts load
        setTimeout(checkLibraries, 500);
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Safely get Recharts components
        let LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine;

// Try multiple ways Recharts might be exported
if (typeof Recharts !== 'undefined') {
    ({ LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine } = Recharts);
} else if (typeof window.Recharts !== 'undefined') {
    ({ LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine } = window.Recharts);
}

// Debug log
console.log('Recharts check:', {
    'typeof Recharts': typeof Recharts,
    'window.Recharts': typeof window.Recharts,
    'LineChart available': typeof LineChart !== 'undefined'
});

        // Check if XLSX library is available (SheetJS for Excel parsing)
        const XLSX = window.XLSX;

        // Lucide icons as SVG components
        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const TrendingUp = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );

        const Package = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
        );

        const FileText = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
        );

        const Clock = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );
	const Briefcase = ({ size = 24 }) => (
       	   <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
           	<rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
           	<path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
          </svg>
   	);

        const Recycle = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M7 19H4.815a1.83 1.83 0 0 1-1.57-.881 1.785 1.785 0 0 1-.004-1.784L7.196 9.5"></path>
                <path d="M11 19h8.203a1.83 1.83 0 0 0 1.556-.89 1.784 1.784 0 0 0 0-1.775l-1.226-2.12"></path>
                <path d="m14 16-3 3 3 3"></path>
                <path d="M8.293 13.596 7.196 9.5 3.1 10.598"></path>
                <path d="m9.344 5.811 1.093-1.892A1.83 1.83 0 0 1 11.985 3a1.784 1.784 0 0 1 1.546.888l3.943 6.843"></path>
                <path d="m13.378 9.633 4.096 1.098 1.097-4.096"></path>
            </svg>
        );

        const ChevronDown = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        );

        const ChevronRight = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        );

        function MaterialsManagement() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [contracts, setContracts] = useState([]);
            const [inventory, setInventory] = useState({
                aluminum5052: { quantity: 0, unit: 'lbs' },
                stainless304: { quantity: 0, unit: 'lbs' }
            });
            const [usageHistory, setUsageHistory] = useState([]);
            const [marketPrices, setMarketPrices] = useState([]);
            const [purchaseHistory, setPurchaseHistory] = useState([]);
            const [showContractForm, setShowContractForm] = useState(false);
            const [showUsageForm, setShowUsageForm] = useState(false);
            const [showMarketPriceForm, setShowMarketPriceForm] = useState(false);
            const [showInventoryForm, setShowInventoryForm] = useState(false);
            const [editingContract, setEditingContract] = useState(null);
            const [editingMarketPrice, setEditingMarketPrice] = useState(null);
            const [editingUsage, setEditingUsage] = useState(null);
            const [showImportDialog, setShowImportDialog] = useState(false);
            const [lastPriceFetch, setLastPriceFetch] = useState(null);
            const [fetchingPrices, setFetchingPrices] = useState(false);
	    const [bidPackages, setBidPackages] = useState([]);
	    const [bids, setBids] = useState([]);
	    const [showBidPackageForm, setShowBidPackageForm] = useState(false);
	    const [showBidForm, setShowBidForm] = useState(false);
	    const [editingBidPackage, setEditingBidPackage] = useState(null);
	    const [editingBid, setEditingBid] = useState(null);
	    const [selectedBidPackage, setSelectedBidPackage] = useState(null);
	    const [scrapContracts, setScrapContracts] = useState([]);
	    const [scrapBids, setScrapBids] = useState([]);
	    const [showScrapContractForm, setShowScrapContractForm] = useState(false);
	    const [showScrapBidForm, setShowScrapBidForm] = useState(false);
	    const [editingScrapContract, setEditingScrapContract] = useState(null);
	    const [editingScrapBid, setEditingScrapBid] = useState(null);
	    const [expandedSite, setExpandedSite] = useState(null);
	    const [scrapWeightTickets, setScrapWeightTickets] = useState([]);
	    const [showWeightTicketForm, setShowWeightTicketForm] = useState(false);
	    const [editingWeightTicket, setEditingWeightTicket] = useState(null);
	    const [expandedWeightTicketSite, setExpandedWeightTicketSite] = useState(null);
	   
            // Load data from localStorage
            useEffect(() => {
                const savedContracts = localStorage.getItem('contracts');
                const savedInventory = localStorage.getItem('inventory');
                const savedUsageHistory = localStorage.getItem('usageHistory');
                const savedMarketPrices = localStorage.getItem('marketPrices');
                const savedPurchaseHistory = localStorage.getItem('purchaseHistory');
                const savedLastPriceFetch = localStorage.getItem('lastPriceFetch');
		const savedBidPackages = localStorage.getItem('bidPackages');
		const savedBids = localStorage.getItem('bids');
		const savedScrapContracts = localStorage.getItem('scrapContracts');
		const savedScrapBids = localStorage.getItem('scrapBids');
		const savedScrapWeightTickets = localStorage.getItem('scrapWeightTickets');
		if (savedBidPackages) setBidPackages(JSON.parse(savedBidPackages));
		if (savedBids) setBids(JSON.parse(savedBids));
		if (savedScrapContracts) setScrapContracts(JSON.parse(savedScrapContracts));
		if (savedScrapBids) setScrapBids(JSON.parse(savedScrapBids));
		if (savedScrapWeightTickets) setScrapWeightTickets(JSON.parse(savedScrapWeightTickets));
            
                if (savedContracts) setContracts(JSON.parse(savedContracts));
                if (savedInventory) setInventory(JSON.parse(savedInventory));
                if (savedUsageHistory) setUsageHistory(JSON.parse(savedUsageHistory));
                if (savedMarketPrices) setMarketPrices(JSON.parse(savedMarketPrices));
                if (savedPurchaseHistory) setPurchaseHistory(JSON.parse(savedPurchaseHistory));
                if (savedLastPriceFetch) setLastPriceFetch(savedLastPriceFetch);
		
            }, []);

            // Save data to localStorage
            useEffect(() => {
                localStorage.setItem('contracts', JSON.stringify(contracts));
            }, [contracts]);

            useEffect(() => {
                localStorage.setItem('inventory', JSON.stringify(inventory));
            }, [inventory]);

            useEffect(() => {
                localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
            }, [usageHistory]);

            useEffect(() => {
                localStorage.setItem('marketPrices', JSON.stringify(marketPrices));
            }, [marketPrices]);
	    useEffect(() => {
       		localStorage.setItem('bidPackages', JSON.stringify(bidPackages));
   	    }, [bidPackages]);

   	    useEffect(() => {
       		localStorage.setItem('bids', JSON.stringify(bids));
   	    }, [bids]);

   	    useEffect(() => {
       		localStorage.setItem('scrapContracts', JSON.stringify(scrapContracts));
   	    }, [scrapContracts]);

   	    useEffect(() => {
       		localStorage.setItem('scrapBids', JSON.stringify(scrapBids));
   	    }, [scrapBids]);

   	    useEffect(() => {
       		localStorage.setItem('scrapWeightTickets', JSON.stringify(scrapWeightTickets));
   	    }, [scrapWeightTickets]);
	
            // Export all data to JSON file
            const exportAllData = () => {
                const allData = {
                    contracts: contracts,
                    inventory: inventory,
                    usageHistory: usageHistory,
                    marketPrices: marketPrices,
                    purchaseHistory: purchaseHistory,
		    bidPackages: bidPackages,
   			bids: bids,
   			scrapContracts: scrapContracts,
   			scrapBids: scrapBids,
   			scrapWeightTickets: scrapWeightTickets,
                    exportDate: new Date().toISOString(),
                    version: '1.3'
                };
                
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `materials-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            // Import data from JSON file
            const importAllData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Import all available data
                        if (data.contracts) setContracts(data.contracts);
                        if (data.inventory) setInventory(data.inventory);
                        if (data.usageHistory) setUsageHistory(data.usageHistory);
                        if (data.marketPrices) setMarketPrices(data.marketPrices);
                        if (data.purchaseHistory) setPurchaseHistory(data.purchaseHistory);
			if (data.bidPackages) setBidPackages(data.bidPackages);
   			if (data.bids) setBids(data.bids);
   			if (data.scrapContracts) setScrapContracts(data.scrapContracts);
   			if (data.scrapBids) setScrapBids(data.scrapBids);
   			if (data.scrapWeightTickets) setScrapWeightTickets(data.scrapWeightTickets);
                        
                        alert(`Data imported successfully!\nExported on: ${data.exportDate ? new Date(data.exportDate).toLocaleString() : 'Unknown'}`);
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            // Fetch latest metal prices from API
            const handleFetchPrices = async () => {
    setIsFetching(true);
    console.log('ðŸŽ¯ Form: Starting fetch...');
    
    const prices = await fetchLatestPrices();
    console.log('ðŸŽ¯ Form: Received prices:', prices);
    
    if (prices) {
        // Prices are already in USD per pound from fetchLatestPrices
        // No additional conversion needed!
        
        const newFormData = {
            ...formData,
            lmeAluminum: prices.aluminum ? prices.aluminum.toFixed(4) : formData.lmeAluminum,
            aluminumBase: prices.aluminum ? prices.aluminum.toFixed(4) : formData.aluminumBase,
            nickel: prices.nickel ? prices.nickel.toFixed(4) : formData.nickel,
            chrome: prices.zinc ? prices.zinc.toFixed(4) : formData.chrome,
            molybdenum: prices.molybdenum ? prices.molybdenum.toFixed(4) : formData.molybdenum,
            scrapIron: prices.steelScrap ? prices.steelScrap.toFixed(4) : formData.scrapIron
        };
        
        console.log('ðŸŽ¯ Form: Setting form data to:', newFormData);
        setFormData(newFormData);
        
        console.log('ðŸŽ¯ Form: State updated!');
    } else {
        console.log('ðŸŽ¯ Form: No prices returned');
    }
    
    setIsFetching(false);
};

            const ContractForm = ({ onClose, onSubmit, initialData = null }) => {
                const [formData, setFormData] = useState(initialData || {
                    id: Date.now(),
                    material: 'aluminum5052',
                    vendor: '',
                    pricePerLb: '',
                    totalQuantity: '',
                    remainingQuantity: '',
                    avgMonthlyUsage: '',
                    orderDate: '',
                    deliveryDate: '',
                    estimatedCompletionDate: '',
                    status: 'future'
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const submitData = {...formData};
                    if (!submitData.remainingQuantity) {
                        submitData.remainingQuantity = submitData.totalQuantity;
                    }
                    onSubmit(submitData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">
                                    {initialData ? 'Edit Contract' : 'Add New Contract'}
                                </h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Material</label>
                                            <select
                                                value={formData.material}
                                                onChange={(e) => setFormData({...formData, material: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            >
                                                <option value="aluminum5052">Aluminum 5052</option>
                                                <option value="stainless304">Stainless Steel 304 2B</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Contract Status</label>
                                            <select
                                                value={formData.status}
                                                onChange={(e) => setFormData({...formData, status: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            >
                                                <option value="future">Future (Ordered, Not Received)</option>
                                                <option value="active">Active (Received, In Use)</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Vendor</label>
                                        <input
                                            type="text"
                                            value={formData.vendor}
                                            onChange={(e) => setFormData({...formData, vendor: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Price per Pound ($)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.pricePerLb}
                                                onChange={(e) => setFormData({...formData, pricePerLb: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">Total Quantity (lbs)</label>
                                            <input
                                                type="number"
                                                value={formData.totalQuantity}
                                                onChange={(e) => setFormData({...formData, totalQuantity: e.target.value, remainingQuantity: formData.remainingQuantity || e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>
                                    </div>

                                    {formData.status === 'active' && (
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Remaining Quantity (lbs)</label>
                                            <input
                                                type="number"
                                                value={formData.remainingQuantity}
                                                onChange={(e) => setFormData({...formData, remainingQuantity: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Update this as material is consumed from the contract</p>
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Average Monthly Usage (lbs)</label>
                                        <input
                                            type="number"
                                            value={formData.avgMonthlyUsage}
                                            onChange={(e) => setFormData({...formData, avgMonthlyUsage: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Order Date</label>
                                            <input
                                                type="date"
                                                value={formData.orderDate}
                                                onChange={(e) => setFormData({...formData, orderDate: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">Expected Delivery Date</label>
                                            <input
                                                type="date"
                                                value={formData.deliveryDate}
                                                onChange={(e) => setFormData({...formData, deliveryDate: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Estimated Completion Date</label>
                                        <input
                                            type="date"
                                            value={formData.estimatedCompletionDate}
                                            onChange={(e) => setFormData({...formData, estimatedCompletionDate: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">When you expect this contract to be fully consumed</p>
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            {initialData ? 'Update Contract' : 'Add Contract'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const UsageForm = ({ onClose, onSubmit, initialData = null }) => {
                const [formData, setFormData] = useState(initialData || {
                    id: Date.now(),
                    month: new Date().toISOString().substring(0, 7), // YYYY-MM format
                    material: 'aluminum5052',
                    quantity: '',
                    notes: ''
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">{initialData ? 'Edit Monthly Usage' : 'Log Monthly Usage'}</h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Month</label>
                                        <input
                                            type="month"
                                            value={formData.month}
                                            onChange={(e) => setFormData({...formData, month: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Material</label>
                                        <select
                                            value={formData.material}
                                            onChange={(e) => setFormData({...formData, material: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        >
                                            <option value="aluminum5052">Aluminum 5052</option>
                                            <option value="stainless304">Stainless Steel 304 2B</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Quantity Used (lbs)</label>
                                        <input
                                            type="number"
                                            value={formData.quantity}
                                            onChange={(e) => setFormData({...formData, quantity: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Notes (Optional)</label>
                                        <textarea
                                            value={formData.notes}
                                            onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            rows="2"
                                        />
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            {initialData ? 'Update Usage' : 'Log Usage'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const ImportDialog = ({ onClose }) => {
                const [importing, setImporting] = useState(false);
                const [importResults, setImportResults] = useState(null);

                const handleFileUpload = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    setImporting(true);
                    try {
                        // Note: This requires the user to have internet connection to load the XLSX library
                        // We'll use the SheetJS library that's already available
                        const data = await file.arrayBuffer();
                        
                        // Parse Excel file using SheetJS (already included in dependencies)
                        const workbook = XLSX.read(data);
                        
                        let results = {
                            contracts: 0,
                            usage: 0,
                            prices: 0,
                            errors: []
                        };

                        // Look for sheets by name
                        if (workbook.SheetNames.includes('Contracts')) {
                            const sheet = workbook.Sheets['Contracts'];
                            const rows = XLSX.utils.sheet_to_json(sheet);
                            
                            rows.forEach((row, idx) => {
                                try {
                                    const contract = {
                                        id: Date.now() + idx,
                                        material: row.Material === 'Aluminum 5052' || row.Material === 'aluminum5052' ? 'aluminum5052' : 'stainless304',
                                        vendor: row.Vendor || '',
                                        pricePerLb: row['Price per Lb'] || row.PricePerLb || '',
                                        totalQuantity: row['Total Quantity'] || row.TotalQuantity || '',
                                        remainingQuantity: row['Remaining Quantity'] || row.RemainingQuantity || row['Total Quantity'] || row.TotalQuantity || '',
                                        avgMonthlyUsage: row['Avg Monthly Usage'] || row.AvgMonthlyUsage || '',
                                        orderDate: row['Order Date'] || row.OrderDate || '',
                                        deliveryDate: row['Delivery Date'] || row.DeliveryDate || '',
                                        estimatedCompletionDate: row['Estimated Completion'] || row.EstimatedCompletion || '',
                                        status: row.Status || 'active'
                                    };
                                    
                                    if (contract.vendor && contract.pricePerLb && contract.totalQuantity) {
                                        setContracts(prev => [...prev, contract]);
                                        results.contracts++;
                                    }
                                } catch (e) {
                                    results.errors.push(`Contract row ${idx + 2}: ${e.message}`);
                                }
                            });
                        }

                        if (workbook.SheetNames.includes('Usage')) {
                            const sheet = workbook.Sheets['Usage'];
                            const rows = XLSX.utils.sheet_to_json(sheet);
                            
                            rows.forEach((row, idx) => {
                                try {
                                    const usage = {
                                        id: Date.now() + idx,
                                        month: row.Month || '',
                                        material: row.Material === 'Aluminum 5052' || row.Material === 'aluminum5052' ? 'aluminum5052' : 'stainless304',
                                        quantity: row.Quantity || '',
                                        notes: row.Notes || ''
                                    };
                                    
                                    if (usage.month && usage.quantity) {
                                        setUsageHistory(prev => [...prev, usage].sort((a, b) => b.month.localeCompare(a.month)));
                                        results.usage++;
                                    }
                                } catch (e) {
                                    results.errors.push(`Usage row ${idx + 2}: ${e.message}`);
                                }
                            });
                        }

                        if (workbook.SheetNames.includes('Market Prices')) {
                            const sheet = workbook.Sheets['Market Prices'];
                            const rows = XLSX.utils.sheet_to_json(sheet);
                            
                            rows.forEach((row, idx) => {
                                try {
                                    const price = {
                                        id: Date.now() + idx,
                                        date: row.Date || '',
                                        lmeAluminum: row['LME Aluminum'] || row.LMEAluminum || '',
                                        aluminumBase: row['Aluminum Base'] || row.AluminumBase || '',
                                        midwestPremium: row['Midwest Premium'] || row.MidwestPremium || '',
                                        nickel: row.Nickel || '',
                                        chrome: row.Chrome || '',
                                        molybdenum: row.Molybdenum || '',
                                        scrapIron: row['Scrap Iron'] || row.ScrapIron || '',
                                        conversionPricing: row['Conversion Pricing'] || row.ConversionPricing || '',
                                        nasStainlessSurcharge: row['NAS Surcharge'] || row.NASSurcharge || '',
                                        outokumpuSurcharge: row['Outokumpu Surcharge'] || row.OutokumpuSurcharge || '',
                                        notes: row.Notes || ''
                                    };
                                    
                                    if (price.date) {
                                        setMarketPrices(prev => [...prev, price].sort((a, b) => new Date(b.date) - new Date(a.date)));
                                        results.prices++;
                                    }
                                } catch (e) {
                                    results.errors.push(`Price row ${idx + 2}: ${e.message}`);
                                }
                            });
                        }

                        setImportResults(results);
                    } catch (error) {
                        setImportResults({ 
                            contracts: 0, 
                            usage: 0, 
                            prices: 0, 
                            errors: [`Failed to parse Excel file: ${error.message}`] 
                        });
                    }
                    setImporting(false);
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">Import from Excel</h2>
                                
                                {!importResults ? (
                                    <>
                                        <div className="mb-4">
                                            <p className="text-sm text-gray-600 mb-4">
                                                Upload an Excel file (.xlsx) with your data. The file should have separate sheets named:
                                            </p>
                                            
                                            <div className="bg-blue-50 p-4 rounded-lg mb-4">
                                                <h3 className="font-semibold text-blue-900 mb-2">Sheet: "Contracts"</h3>
                                                <p className="text-sm text-blue-800">Columns: Material, Vendor, Price per Lb, Total Quantity, Remaining Quantity, Avg Monthly Usage, Order Date, Delivery Date, Estimated Completion, Status</p>
                                            </div>

                                            <div className="bg-green-50 p-4 rounded-lg mb-4">
                                                <h3 className="font-semibold text-green-900 mb-2">Sheet: "Usage"</h3>
                                                <p className="text-sm text-green-800">Columns: Month (YYYY-MM), Material, Quantity, Notes</p>
                                            </div>

                                            <div className="bg-purple-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-purple-900 mb-2">Sheet: "Market Prices"</h3>
                                                <p className="text-sm text-purple-800">Columns: Date, LME Aluminum, Aluminum Base, Midwest Premium, Nickel, Chrome, Molybdenum, Scrap Iron, Conversion Pricing, NAS Surcharge, Outokumpu Surcharge, Notes</p>
                                            </div>
                                        </div>

                                        <input
                                            type="file"
                                            accept=".xlsx,.xls"
                                            onChange={handleFileUpload}
                                            className="w-full border rounded px-3 py-2 mb-4"
                                            disabled={importing}
                                        />

                                        {importing && (
                                            <div className="text-center py-4">
                                                <p className="text-blue-600">Importing data...</p>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <div>
                                        <h3 className="font-semibold mb-3">Import Results:</h3>
                                        <div className="space-y-2 mb-4">
                                            <p className="text-green-600">âœ“ Contracts imported: {importResults.contracts}</p>
                                            <p className="text-green-600">âœ“ Usage records imported: {importResults.usage}</p>
                                            <p className="text-green-600">âœ“ Market prices imported: {importResults.prices}</p>
                                        </div>

                                        {importResults.errors.length > 0 && (
                                            <div className="bg-red-50 p-4 rounded-lg mb-4">
                                                <h4 className="font-semibold text-red-900 mb-2">Errors:</h4>
                                                <ul className="text-sm text-red-800 list-disc list-inside">
                                                    {importResults.errors.map((error, idx) => (
                                                        <li key={idx}>{error}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        <button
                                            onClick={onClose}
                                            className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            Done
                                        </button>
                                    </div>
                                )}

                                {!importResults && (
                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const InventoryForm = ({ onClose, onSubmit, currentInventory }) => {
                const [formData, setFormData] = useState({
                    aluminum5052: currentInventory.aluminum5052.quantity,
                    stainless304: currentInventory.stainless304.quantity
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">Update Inventory Levels</h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Aluminum 5052 Stock (lbs)</label>
                                        <input
                                            type="number"
                                            value={formData.aluminum5052}
                                            onChange={(e) => setFormData({...formData, aluminum5052: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Stainless Steel 304 2B Stock (lbs)</label>
                                        <input
                                            type="number"
                                            value={formData.stainless304}
                                            onChange={(e) => setFormData({...formData, stainless304: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            Update Inventory
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const MarketPriceForm = ({ onClose, onSubmit, initialData = null }) => {
    const [formData, setFormData] = useState(initialData || {
        id: Date.now(),
        date: new Date().toISOString().split('T')[0],
        lmeAluminum: '',
        aluminumBase: '',
        midwestPremium: '',
        nickel: '',
        chrome: '',
        molybdenum: '',
        scrapIron: '',
        conversionPricing: '',
        nasStainlessSurcharge: '',
        outokumpuSurcharge: '',
        ourAluminumCost: '',
        ourStainlessCost: '',
        notes: ''
    });
    
    const [isFetching, setIsFetching] = useState(false);

    const handleSubmit = (e) => {
        e.preventDefault();
        console.log('ðŸ’¾ Saving:', formData);
        onSubmit(formData);
        onClose();
    };

    const handleFetchPrices = async () => {
        setIsFetching(true);
        console.log('ðŸ”„ Starting price fetch...');
        
        try {
            const API_KEY = localStorage.getItem('metalsApiKey') || 'DEMO_KEY';
            let prices = {};
            
            if (API_KEY === 'DEMO_KEY' || !API_KEY) {
                // Demo mode - already in $/lb
                prices = {
                    aluminum: 1.20,
                    nickel: 7.50,
                    zinc: 1.15,
                    molybdenum: 18.50,
                    steelScrap: 0.45
                };
                
                console.log('ðŸ“Š Using demo prices:', prices);
                alert('Demo Mode: Using sample prices.\n\nAluminum: $1.20/lb\nNickel: $7.50/lb\nZinc: $1.15/lb');
                
            } else {
                // Real API call
                const apiUrl = `https://metals-api.com/api/latest?access_key=${API_KEY}&base=USD&symbols=ALU3M,NI3M,ZNC3M,MO,STEEL-SC`;
                
                console.log('ðŸŒ Fetching from API...');
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                console.log('ðŸ“¥ API Response:', data);
                
                if (!data.success) {
                    throw new Error(data.error?.info || 'API request failed');
                }
                
                // Extract raw API values
                const rawRates = {
                    aluminum: data.rates?.ALU3M || data.rates?.ALU,
                    nickel: data.rates?.NI3M || data.rates?.NI,
                    zinc: data.rates?.ZNC3M || data.rates?.ZNC,
                    molybdenum: data.rates?.MO,
                    steelScrap: data.rates?.['STEEL-SC']
                };
                
                console.log('ðŸ“Š Raw API rates:', rawRates);
                
                // Convert: API returns "troy oz per USD", we need "USD per lb"
                // Step 1: Invert to get USD per troy oz
                // Step 2: Divide by 0.0685714 to get USD per lb
                
                for (const [metal, rate] of Object.entries(rawRates)) {
                    if (rate) {
                        const usdPerTroyOz = 1 / rate;
                        const usdPerLb = usdPerTroyOz / 0.0685714;
                        prices[metal] = usdPerLb;
                        console.log(`  ${metal}: ${rate} troy oz/$1 â†’ $${usdPerTroyOz.toFixed(4)}/oz â†’ $${usdPerLb.toFixed(4)}/lb`);
                    }
                }
                
                console.log('âœ… Converted prices:', prices);
            }
            
            // Update form with fetched prices
            const updatedData = {
                ...formData,
                lmeAluminum: prices.aluminum ? prices.aluminum.toFixed(4) : formData.lmeAluminum,
                aluminumBase: prices.aluminum ? prices.aluminum.toFixed(4) : formData.aluminumBase,
                nickel: prices.nickel ? prices.nickel.toFixed(4) : formData.nickel,
                chrome: prices.zinc ? prices.zinc.toFixed(4) : formData.chrome,
                molybdenum: prices.molybdenum ? prices.molybdenum.toFixed(4) : formData.molybdenum,
                scrapIron: prices.steelScrap ? prices.steelScrap.toFixed(4) : formData.scrapIron
            };
            
            console.log('ðŸ“ Updated form data:', updatedData);
            setFormData(updatedData);
            
            // Update last fetch time
            const now = new Date().toISOString();
            localStorage.setItem('lastPriceFetch', now);
            
            alert('âœ… Prices fetched successfully!\n\nReview the values and click Save when ready.');
            
        } catch (error) {
            console.error('âŒ Fetch error:', error);
            alert('Error fetching prices: ' + error.message + '\n\nYou can enter prices manually.');
        }
        
        setIsFetching(false);
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6">
                    <div className="flex justify-between items-start mb-4">
                        <h2 className="text-2xl font-bold">
                            {initialData ? 'Edit Market Prices' : 'Enter Market Prices'}
                        </h2>
                        {!initialData && (
                            <button
                                type="button"
                                onClick={handleFetchPrices}
                                disabled={isFetching}
                                className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400 text-sm flex items-center gap-2"
                            >
                                {isFetching ? (
                                    <>
                                        <span className="inline-block animate-spin">âŸ³</span>
                                        Fetching...
                                    </>
                                ) : (
                                    <>ðŸ”„ Fetch Latest Prices</>
                                )}
                            </button>
                        )}
                    </div>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Date</label>
                            <input
                                type="date"
                                value={formData.date}
                                onChange={(e) => setFormData({...formData, date: e.target.value})}
                                className="w-full border rounded px-3 py-2"
                                required
                            />
                        </div>

                        <div className="border-t pt-4">
                            <h3 className="font-semibold mb-3 text-lg">Aluminum Pricing</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        LME Aluminum ($/lb)
                                        {formData.lmeAluminum && <span className="text-green-600 ml-2">âœ“</span>}
                                    </label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.lmeAluminum}
                                        onChange={(e) => setFormData({...formData, lmeAluminum: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Auto-filled from API"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        Aluminum Base ($/lb)
                                        {formData.aluminumBase && <span className="text-green-600 ml-2">âœ“</span>}
                                    </label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.aluminumBase}
                                        onChange={(e) => setFormData({...formData, aluminumBase: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Auto-filled from API"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Midwest Premium ($/lb)</label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.midwestPremium}
                                        onChange={(e) => setFormData({...formData, midwestPremium: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Enter manually"
                                    />
                                </div>
                            </div>
                        </div>
<div className="border-t pt-4 bg-blue-50 p-4 rounded">
                            <h3 className="font-semibold mb-3 text-lg text-blue-900">ðŸ“Š Our Actual Costs (For Tracking)</h3>
                            <p className="text-sm text-gray-700 mb-3">Enter what you're currently paying from your active contracts to track savings vs market</p>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Our Aluminum Cost ($/lb)</label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.ourAluminumCost}
                                        onChange={(e) => setFormData({...formData, ourAluminumCost: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="e.g., 1.15"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Current contract price for Al 5052</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Our Stainless Cost ($/lb)</label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.ourStainlessCost}
                                        onChange={(e) => setFormData({...formData, ourStainlessCost: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="e.g., 2.45"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Current contract price for SS 304</p>
                                </div>
                            </div>
                        </div>
                        <div className="border-t pt-4">
                            <h3 className="font-semibold mb-3 text-lg">Stainless Steel Components</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        Nickel ($/lb)
                                        {formData.nickel && <span className="text-green-600 ml-2">âœ“</span>}
                                    </label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.nickel}
                                        onChange={(e) => setFormData({...formData, nickel: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Auto-filled from API"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        Chrome ($/lb)
                                        {formData.chrome && <span className="text-green-600 ml-2">âœ“</span>}
                                    </label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.chrome}
                                        onChange={(e) => setFormData({...formData, chrome: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Auto-filled from API"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        Molybdenum ($/lb)
                                        {formData.molybdenum && <span className="text-green-600 ml-2">âœ“</span>}
                                    </label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.molybdenum}
                                        onChange={(e) => setFormData({...formData, molybdenum: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Auto-filled from API"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        Scrap Iron ($/lb)
                                        {formData.scrapIron && <span className="text-green-600 ml-2">âœ“</span>}
                                    </label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.scrapIron}
                                        onChange={(e) => setFormData({...formData, scrapIron: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Auto-filled from API"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Conversion Pricing ($/lb)</label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.conversionPricing}
                                        onChange={(e) => setFormData({...formData, conversionPricing: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Enter manually"
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="border-t pt-4">
                            <h3 className="font-semibold mb-3 text-lg">Stainless Surcharges</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">North American Stainless ($/lb)</label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.nasStainlessSurcharge}
                                        onChange={(e) => setFormData({...formData, nasStainlessSurcharge: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Enter manually"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Outokumpu ($/lb)</label>
                                    <input
                                        type="number"
                                        step="0.0001"
                                        value={formData.outokumpuSurcharge}
                                        onChange={(e) => setFormData({...formData, outokumpuSurcharge: e.target.value})}
                                        className="w-full border rounded px-3 py-2"
                                        placeholder="Enter manually"
                                    />
                                </div>
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Notes (Optional)</label>
                            <textarea
                                value={formData.notes}
                                onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                className="w-full border rounded px-3 py-2"
                                rows="2"
                                placeholder="Add any notes about these prices"
                            />
                        </div>

                        <div className="flex justify-end gap-2 pt-4 border-t">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-4 py-2 border rounded hover:bg-gray-100"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                {initialData ? 'Update Prices' : 'Save Prices'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );
};
const BidPackageForm = ({ onClose, onSubmit, initialData = null }) => {
    const [formData, setFormData] = useState(initialData || {
        id: Date.now(),
        name: '',
        material: 'aluminum5052',
        targetQuantity: '',
        period: '',
        notes: '',
        status: 'open',
        createdDate: new Date().toISOString().split('T')[0]
    });

    const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit(formData);
        onClose();
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                <div className="p-6">
                    <h2 className="text-2xl font-bold mb-4">
                        {initialData ? 'Edit Bid Package' : 'Create New Bid Package'}
                    </h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Package Name</label>
                            <input
                                type="text"
                                value={formData.name}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                placeholder="e.g., Q4 2025 Aluminum Contract"
                                className="w-full border rounded px-3 py-2"
                                required
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Material</label>
                                <select
                                    value={formData.material}
                                    onChange={(e) => setFormData({...formData, material: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                    required
                                >
                                    <option value="aluminum5052">Aluminum 5052</option>
                                    <option value="stainless304">Stainless Steel 304 2B</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Target Quantity (lbs)</label>
                                <input
                                    type="number"
                                    value={formData.targetQuantity}
                                    onChange={(e) => setFormData({...formData, targetQuantity: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                    required
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Period</label>
                                <input
                                    type="text"
                                    value={formData.period}
                                    onChange={(e) => setFormData({...formData, period: e.target.value})}
                                    placeholder="e.g., Q4 2025"
                                    className="w-full border rounded px-3 py-2"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Status</label>
                                <select
                                    value={formData.status}
                                    onChange={(e) => setFormData({...formData, status: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                >
                                    <option value="open">Open for Bids</option>
                                    <option value="reviewing">Under Review</option>
                                    <option value="awarded">Awarded</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Notes</label>
                            <textarea
                                value={formData.notes}
                                onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                className="w-full border rounded px-3 py-2"
                                rows="3"
                                placeholder="Any special requirements or notes about this bid package"
                            />
                        </div>

                        <div className="flex justify-end gap-2 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-4 py-2 border rounded hover:bg-gray-100"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                {initialData ? 'Update Package' : 'Create Package'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );
};
const BidForm = ({ onClose, onSubmit, bidPackage, initialData = null }) => {
    const [formData, setFormData] = useState(initialData || {
        id: Date.now(),
        packageId: bidPackage.id,
        vendor: '',
        pricePerLb: '',
        totalQuantity: bidPackage.targetQuantity,
        leadTime: '',
        paymentTerms: '',
        minimumOrderQty: '',
        notes: '',
        receivedDate: new Date().toISOString().split('T')[0]
    });

    const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit(formData);
        onClose();
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6">
                    <h2 className="text-2xl font-bold mb-4">
                        {initialData ? 'Edit Vendor Bid' : 'Add Vendor Bid'}
                    </h2>
                    <div className="bg-blue-50 p-3 rounded mb-4">
                        <p className="text-sm text-blue-900"><strong>Bid Package:</strong> {bidPackage.name}</p>
                        <p className="text-sm text-blue-800">Target: {parseFloat(bidPackage.targetQuantity).toLocaleString()} lbs</p>
                    </div>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Vendor Name</label>
                            <input
                                type="text"
                                value={formData.vendor}
                                onChange={(e) => setFormData({...formData, vendor: e.target.value})}
                                className="w-full border rounded px-3 py-2"
                                required
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Price per Pound ($)</label>
                                <input
                                    type="number"
                                    step="0.0001"
                                    value={formData.pricePerLb}
                                    onChange={(e) => setFormData({...formData, pricePerLb: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Total Quantity (lbs)</label>
                                <input
                                    type="number"
                                    value={formData.totalQuantity}
                                    onChange={(e) => setFormData({...formData, totalQuantity: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                    required
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Lead Time (weeks)</label>
                                <input
                                    type="number"
                                    value={formData.leadTime}
                                    onChange={(e) => setFormData({...formData, leadTime: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                    placeholder="e.g., 8"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Payment Terms</label>
                                <input
                                    type="text"
                                    value={formData.paymentTerms}
                                    onChange={(e) => setFormData({...formData, paymentTerms: e.target.value})}
                                    className="w-full border rounded px-3 py-2"
                                    placeholder="e.g., Net 30"
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Minimum Order Quantity (lbs)</label>
                            <input
                                type="number"
                                value={formData.minimumOrderQty}
                                onChange={(e) => setFormData({...formData, minimumOrderQty: e.target.value})}
                                className="w-full border rounded px-3 py-2"
                                placeholder="Optional"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Bid Received Date</label>
                            <input
                                type="date"
                                value={formData.receivedDate}
                                onChange={(e) => setFormData({...formData, receivedDate: e.target.value})}
                                className="w-full border rounded px-3 py-2"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Notes / Special Conditions</label>
                            <textarea
                                value={formData.notes}
                                onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                className="w-full border rounded px-3 py-2"
                                rows="3"
                                placeholder="Any special terms, conditions, or notes about this bid"
                            />
                        </div>

                        <div className="flex justify-end gap-2 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-4 py-2 border rounded hover:bg-gray-100"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                {initialData ? 'Update Bid' : 'Add Bid'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );
};
const ContractBidsView = () => {
    const addBidPackage = (pkg) => {
        setBidPackages([...bidPackages, pkg]);
    };

    const updateBidPackage = (updatedPkg) => {
        setBidPackages(bidPackages.map(p => p.id === updatedPkg.id ? updatedPkg : p));
    };

    const deleteBidPackage = (id) => {
        if (confirm('Are you sure you want to delete this bid package? All associated bids will also be deleted.')) {
            setBidPackages(bidPackages.filter(p => p.id !== id));
            setBids(bids.filter(b => b.packageId !== id));
        }
    };

    const addBid = (bid) => {
        setBids([...bids, bid]);
    };

    const updateBid = (updatedBid) => {
        setBids(bids.map(b => b.id === updatedBid.id ? updatedBid : b));
    };

    const deleteBid = (id) => {
        if (confirm('Are you sure you want to delete this bid?')) {
            setBids(bids.filter(b => b.id !== id));
        }
    };

    const getBidsForPackage = (packageId) => {
        return bids.filter(b => b.packageId === packageId);
    };

    const getLowestBid = (packageBids) => {
        if (packageBids.length === 0) return null;
        return packageBids.reduce((lowest, bid) => 
            parseFloat(bid.pricePerLb) < parseFloat(lowest.pricePerLb) ? bid : lowest
        );
    };

    const convertBidToContract = (bid) => {
        const pkg = bidPackages.find(p => p.id === bid.packageId);
        if (!pkg) return;

        const newContract = {
            id: Date.now(),
            material: pkg.material,
            vendor: bid.vendor,
            pricePerLb: bid.pricePerLb,
            totalQuantity: bid.totalQuantity,
            remainingQuantity: bid.totalQuantity,
            avgMonthlyUsage: '',
            orderDate: new Date().toISOString().split('T')[0],
            deliveryDate: '',
            estimatedCompletionDate: '',
            status: 'future',
            notes: `Converted from bid package: ${pkg.name}`
        };

        if (confirm(`Convert this bid from ${bid.vendor} to a contract?\n\nThis will create a new contract with:\nPrice: $${bid.pricePerLb}/lb\nQuantity: ${parseFloat(bid.totalQuantity).toLocaleString()} lbs`)) {
            setContracts([...contracts, newContract]);
            
            // Update bid package status to awarded
            const updatedPkg = {...pkg, status: 'awarded'};
            updateBidPackage(updatedPkg);
            
            alert('Contract created successfully! You can view it in the Contracts tab.');
            setActiveTab('contracts');
        }
    };

    // If viewing a specific package's bids
    if (selectedBidPackage) {
        const packageBids = getBidsForPackage(selectedBidPackage.id);
        const lowestBid = getLowestBid(packageBids);

        return (
            <div className="space-y-4">
                <div className="flex items-center gap-4 mb-6">
                    <button
                        onClick={() => setSelectedBidPackage(null)}
                        className="text-blue-600 hover:text-blue-800"
                    >
                        â† Back to Bid Packages
                    </button>
                </div>

                <div className="bg-white p-6 rounded-lg shadow">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h2 className="text-2xl font-bold">{selectedBidPackage.name}</h2>
                            <div className="mt-2 space-y-1">
                                <p className="text-sm text-gray-600">
                                    <strong>Material:</strong> {selectedBidPackage.material === 'aluminum5052' ? 'Aluminum 5052' : 'Stainless Steel 304 2B'}
                                </p>
                                <p className="text-sm text-gray-600">
                                    <strong>Target Quantity:</strong> {parseFloat(selectedBidPackage.targetQuantity).toLocaleString()} lbs
                                </p>
                                <p className="text-sm text-gray-600">
                                    <strong>Period:</strong> {selectedBidPackage.period}
                                </p>
                                <p className="text-sm text-gray-600">
                                    <strong>Status:</strong> <span className={`px-2 py-0.5 rounded text-xs ${
                                        selectedBidPackage.status === 'open' ? 'bg-green-100 text-green-800' :
                                        selectedBidPackage.status === 'reviewing' ? 'bg-yellow-100 text-yellow-800' :
                                        selectedBidPackage.status === 'awarded' ? 'bg-blue-100 text-blue-800' :
                                        'bg-gray-100 text-gray-800'
                                    }`}>{selectedBidPackage.status}</span>
                                </p>
                                {selectedBidPackage.notes && (
                                    <p className="text-sm text-gray-600">
                                        <strong>Notes:</strong> {selectedBidPackage.notes}
                                    </p>
                                )}
                            </div>
                        </div>
                        <button
                            onClick={() => {
                                setEditingBid(null);
                                setShowBidForm(true);
                            }}
                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                        >
                            <Plus size={20} />
                            Add Vendor Bid
                        </button>
                    </div>

                    {packageBids.length > 0 && lowestBid && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <h3 className="font-semibold text-green-900 mb-1">Best Bid</h3>
                            <p className="text-lg font-bold text-green-700">
                                {lowestBid.vendor} - ${lowestBid.pricePerLb}/lb
                            </p>
                            <p className="text-sm text-green-800">
                                Total: ${(parseFloat(lowestBid.pricePerLb) * parseFloat(lowestBid.totalQuantity)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </p>
                        </div>
                    )}

                    {packageBids.length > 0 ? (
                        <div className="space-y-3">
                            {packageBids.sort((a, b) => parseFloat(a.pricePerLb) - parseFloat(b.pricePerLb)).map(bid => {
                                const isLowest = lowestBid && bid.id === lowestBid.id;
                                const totalCost = parseFloat(bid.pricePerLb) * parseFloat(bid.totalQuantity);
                                
                                return (
                                    <div key={bid.id} className={`border rounded-lg p-4 ${isLowest ? 'border-green-500 bg-green-50' : ''}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <h3 className="text-lg font-semibold">{bid.vendor}</h3>
                                                    {isLowest && (
                                                        <span className="px-2 py-0.5 bg-green-600 text-white text-xs rounded">
                                                            BEST PRICE
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-xs text-gray-500">Received: {bid.receivedDate}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-2xl font-bold text-blue-600">${bid.pricePerLb}/lb</p>
                                                <p className="text-sm text-gray-600">Total: ${totalCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                            <div>
                                                <p className="text-xs text-gray-500">Quantity</p>
                                                <p className="font-medium">{parseFloat(bid.totalQuantity).toLocaleString()} lbs</p>
                                            </div>
                                            {bid.leadTime && (
                                                <div>
                                                    <p className="text-xs text-gray-500">Lead Time</p>
                                                    <p className="font-medium">{bid.leadTime} weeks</p>
                                                </div>
                                            )}
                                            {bid.paymentTerms && (
                                                <div>
                                                    <p className="text-xs text-gray-500">Payment Terms</p>
                                                    <p className="font-medium">{bid.paymentTerms}</p>
                                                </div>
                                            )}
                                            {bid.minimumOrderQty && (
                                                <div>
                                                    <p className="text-xs text-gray-500">Min Order</p>
                                                    <p className="font-medium">{parseFloat(bid.minimumOrderQty).toLocaleString()} lbs</p>
                                                </div>
                                            )}
                                        </div>

                                        {bid.notes && (
                                            <div className="mb-3">
                                                <p className="text-xs text-gray-500 mb-1">Notes</p>
                                                <p className="text-sm text-gray-700">{bid.notes}</p>
                                            </div>
                                        )}

                                        <div className="flex gap-2 pt-3 border-t">
                                            <button
                                                onClick={() => convertBidToContract(bid)}
                                                className="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700"
                                            >
                                                Convert to Contract
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setEditingBid(bid);
                                                    setShowBidForm(true);
                                                }}
                                                className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                                            >
                                                Edit
                                            </button>
                                            <button
                                                onClick={() => deleteBid(bid.id)}
                                                className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="text-center py-12 text-gray-500">
                            <p>No vendor bids yet for this package.</p>
                            <p className="text-sm mt-2">Click "Add Vendor Bid" to add the first bid.</p>
                        </div>
                    )}
                </div>
            </div>
        );
    }
return (
        <div className="space-y-4">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold">Contract Bids</h2>
                <button
                    onClick={() => {
                        setEditingBidPackage(null);
                        setShowBidPackageForm(true);
                    }}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                    <Plus size={20} />
                    New Bid Package
                </button>
            </div>

            {bidPackages.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {bidPackages.map(pkg => {
                        const packageBids = getBidsForPackage(pkg.id);
                        const lowestBid = getLowestBid(packageBids);
                        
                        return (
                            <div key={pkg.id} className="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow">
                                <div className="flex justify-between items-start mb-3">
                                    <div className="flex-1">
                                        <h3 className="text-lg font-semibold">{pkg.name}</h3>
                                        <p className="text-sm text-gray-600 mt-1">
                                            {pkg.material === 'aluminum5052' ? 'Aluminum 5052' : 'Stainless Steel 304 2B'}
                                        </p>
                                    </div>
                                    <span className={`px-2 py-1 rounded text-xs ${
                                        pkg.status === 'open' ? 'bg-green-100 text-green-800' :
                                        pkg.status === 'reviewing' ? 'bg-yellow-100 text-yellow-800' :
                                        pkg.status === 'awarded' ? 'bg-blue-100 text-blue-800' :
                                        'bg-gray-100 text-gray-800'
                                    }`}>
                                        {pkg.status}
                                    </span>
                                </div>

                                <div className="space-y-2 mb-4">
                                    <div className="flex justify-between text-sm">
                                        <span className="text-gray-600">Target Quantity:</span>
                                        <span className="font-medium">{parseFloat(pkg.targetQuantity).toLocaleString()} lbs</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-gray-600">Period:</span>
                                        <span className="font-medium">{pkg.period}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-gray-600">Bids Received:</span>
                                        <span className="font-medium">{packageBids.length}</span>
                                    </div>
                                    {lowestBid && (
                                        <div className="flex justify-between text-sm pt-2 border-t">
                                            <span className="text-gray-600">Best Price:</span>
                                            <span className="font-bold text-green-600">
                                                ${lowestBid.pricePerLb}/lb ({lowestBid.vendor})
                                            </span>
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setSelectedBidPackage(pkg)}
                                        className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                                    >
                                        View Bids ({packageBids.length})
                                    </button>
                                    <button
                                        onClick={() => {
                                            setEditingBidPackage(pkg);
                                            setShowBidPackageForm(true);
                                        }}
                                        className="px-3 py-2 border rounded hover:bg-gray-100 text-sm"
                                    >
                                        Edit
                                    </button>
                                    <button
                                        onClick={() => deleteBidPackage(pkg.id)}
                                        className="px-3 py-2 border border-red-300 text-red-600 rounded hover:bg-red-50 text-sm"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <div className="bg-white rounded-lg shadow p-12 text-center text-gray-500">
                    <Briefcase size={48} className="mx-auto mb-4 text-gray-400" />
                    <p className="text-lg mb-2">No bid packages yet</p>
                    <p className="text-sm mb-4">Create a bid package to start collecting vendor quotes</p>
                    <button
                        onClick={() => {
                            setEditingBidPackage(null);
                            setShowBidPackageForm(true);
                        }}
                        className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                        <Plus size={20} />
                        Create Your First Bid Package
                    </button>
                </div>
            )}
        </div>
    );
};

            const addContract = (contract) => {
                setContracts([...contracts, contract]);
            };

            const updateContract = (updatedContract) => {
                setContracts(contracts.map(c => c.id === updatedContract.id ? updatedContract : c));
            };

            const addUsage = (usage) => {
                setUsageHistory([...usageHistory, usage].sort((a, b) => b.month.localeCompare(a.month)));
                
                // Update inventory (reduce stock by usage amount)
                const newInventory = {...inventory};
                newInventory[usage.material].quantity -= parseFloat(usage.quantity);
                setInventory(newInventory);
                
                // Note: Contract remaining quantities are managed separately through contract editing
            };

            const updateUsage = (updatedUsage) => {
                // Find the old usage to adjust inventory back
                const oldUsage = usageHistory.find(u => u.id === updatedUsage.id);
                if (oldUsage) {
                    // Add back the old quantity, subtract the new quantity
                    const newInventory = {...inventory};
                    newInventory[oldUsage.material].quantity += parseFloat(oldUsage.quantity);
                    newInventory[updatedUsage.material].quantity -= parseFloat(updatedUsage.quantity);
                    setInventory(newInventory);
                }
                
                setUsageHistory(usageHistory.map(u => u.id === updatedUsage.id ? updatedUsage : u).sort((a, b) => b.month.localeCompare(a.month)));
            };

            const addMarketPrice = (price) => {
                setMarketPrices([...marketPrices, price].sort((a, b) => new Date(b.date) - new Date(a.date)));
            };

            const updateMarketPrice = (updatedPrice) => {
                setMarketPrices(marketPrices.map(p => p.id === updatedPrice.id ? updatedPrice : p).sort((a, b) => new Date(b.date) - new Date(a.date)));
            };

            const deleteMarketPrice = (id) => {
                if (confirm('Are you sure you want to delete this market price entry?')) {
                    setMarketPrices(marketPrices.filter(p => p.id !== id));
                }
            };

            const updateInventory = (newInventory) => {
                setInventory({
                    aluminum5052: { quantity: parseFloat(newInventory.aluminum5052), unit: 'lbs' },
                    stainless304: { quantity: parseFloat(newInventory.stainless304), unit: 'lbs' }
                });
            };

            const getLatestMarketPrice = () => {
                return marketPrices.length > 0 ? marketPrices[0] : null;
            };

            const calculateMarketPrice = (material) => {
    const latest = getLatestMarketPrice();
    if (!latest) return null;

    if (material === 'aluminum5052') {
        // Aluminum calculation: ((Midwest - Base) / Midwest) + LME
        const base = parseFloat(latest.aluminumBase) || 0;
        const midwest = parseFloat(latest.midwestPremium) || 0;
        const lme = parseFloat(latest.lmeAluminum) || 0;
        
        // Calculate total using new formula
        let total = 0;
        if (midwest !== 0) {
            total = ((midwest - base) / midwest) + lme;
        } else {
            // Fallback if midwest is 0 to avoid division by zero
            total = lme;
        }
        
        return {
            lme: lme,
            base: base,
            midwest: midwest,
            total: total
        };
    } else if (material === 'stainless304') {
        // 304 Stainless Steel calculation with alloy composition
        
        // Get component prices
        const nickelPerLb = parseFloat(latest.nickel) || 0;
        const chromePerLb = parseFloat(latest.chrome) || 0;
        const scrapIronPerLb = parseFloat(latest.scrapIron) || 0;
        const conversionPricing = parseFloat(latest.conversionPricing) || 0;
        
        // Calculate each component based on alloy composition
        
        // Nickel: 8% of alloy, with pricing formula
        const nickelComponent = ((nickelPerLb / 2) * 1.2) * 0.08;
        
        // Chrome: 18% of alloy, with pricing formula
        const chromeComponent = (chromePerLb - 0.35) * 0.18 * 1.2;
        
        // Scrap Iron: 71.9% of alloy (balance), with long ton conversion
        const scrapIronComponent = (((scrapIronPerLb * 2240) - 140) / 2240) * 0.719;
        
        // Total market price
        const total = nickelComponent + chromeComponent + scrapIronComponent + conversionPricing;
        
        // Return detailed breakdown
        return {
            nickel: nickelPerLb,
            nickelComponent: nickelComponent,
            chrome: chromePerLb,
            chromeComponent: chromeComponent,
            scrapIron: scrapIronPerLb,
            scrapIronComponent: scrapIronComponent,
            conversion: conversionPricing,
            total: total,
            breakdown: {
                nickel: nickelComponent,
                chrome: chromeComponent,
                iron: scrapIronComponent,
                conversion: conversionPricing
            }
        };
    }
  };

            const Dashboard = () => {
                const futureContracts = contracts.filter(c => c.status === 'future');
                const alContracts = contracts.filter(c => c.material === 'aluminum5052' && c.status === 'active');
                const ssContracts = contracts.filter(c => c.material === 'stainless304' && c.status === 'active');
                
                const alMarketPrice = calculateMarketPrice('aluminum5052');
                const ssMarketPrice = calculateMarketPrice('stainless304');

                // Calculate average monthly usage for projections
                const calculateAverageUsage = (material) => {
                    const materialUsage = usageHistory.filter(u => u.material === material);
                    if (materialUsage.length === 0) return 0;
                    const total = materialUsage.reduce((sum, u) => sum + parseFloat(u.quantity), 0);
                    return total / materialUsage.length;
                };

                const alAvgMonthlyUsage = calculateAverageUsage('aluminum5052');
                const ssAvgMonthlyUsage = calculateAverageUsage('stainless304');

                // Calculate days remaining based on usage rate
                const calculateDaysRemaining = (remainingQty, avgMonthlyUsage) => {
                    if (avgMonthlyUsage === 0) return null;
                    // Convert monthly usage to daily usage (assuming ~22 working days per month)
                    const dailyUsage = avgMonthlyUsage / 22;
                    const workingDaysRemaining = Math.ceil(remainingQty / dailyUsage);
                    return workingDaysRemaining;
                };

                // Calculate estimated completion date based on working days
                const calculateCompletionDate = (remainingQty, avgMonthlyUsage) => {
                    if (avgMonthlyUsage === 0 || remainingQty <= 0) return null;
                    
                    // Convert monthly usage to daily usage (assuming ~22 working days per month)
                    const dailyUsage = avgMonthlyUsage / 22;
                    const workingDaysRemaining = Math.ceil(remainingQty / dailyUsage);
                    
                    // Add working days to current date (skip weekends)
                    let completionDate = new Date();
                    let daysToAdd = workingDaysRemaining;
                    
                    while (daysToAdd > 0) {
                        completionDate.setDate(completionDate.getDate() + 1);
                        // Skip weekends (0 = Sunday, 6 = Saturday)
                        if (completionDate.getDay() !== 0 && completionDate.getDay() !== 6) {
                            daysToAdd--;
                        }
                    }
                    
                    return completionDate;
                };

                const usageByMonth = {};
                usageHistory.forEach(u => {
                    const month = u.month; // Already in YYYY-MM format
                    if (!usageByMonth[month]) {
                        usageByMonth[month] = { aluminum5052: 0, stainless304: 0 };
                    }
                    usageByMonth[month][u.material] += parseFloat(u.quantity);
                });

                const usageChartData = Object.keys(usageByMonth).sort().slice(-6).map(month => ({
                    month,
                    Aluminum: Math.round(usageByMonth[month].aluminum5052),
                    Stainless: Math.round(usageByMonth[month].stainless304)
                }));

                   return (
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600">Active Contracts</p>
                                        <p className="text-3xl font-bold">{contracts.filter(c => c.status === 'active').length}</p>
                                    </div>
                                    <FileText size={32} className="text-blue-600" />
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600">Future Contracts</p>
                                        <p className="text-3xl font-bold">{futureContracts.length}</p>
                                    </div>
                                    <Clock size={32} className="text-orange-600" />
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600">Al 5052 Stock</p>
                                        <p className="text-3xl font-bold">{inventory.aluminum5052.quantity.toLocaleString()}</p>
                                        <p className="text-xs text-gray-500">lbs</p>
                                    </div>
                                    <Package size={32} className="text-green-600" />
                                </div>
                                <button
                                    onClick={() => setShowInventoryForm(true)}
                                    className="mt-3 text-xs text-blue-600 hover:text-blue-800"
                                >
                                    Update Stock Levels
                                </button>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600">SS 304 Stock</p>
                                        <p className="text-3xl font-bold">{inventory.stainless304.quantity.toLocaleString()}</p>
                                        <p className="text-xs text-gray-500">lbs</p>
                                    </div>
                                    <Package size={32} className="text-purple-600" />
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4">Aluminum 5052 - Active Contracts</h3>
                                {alContracts.length > 0 ? (
                                    <div className="space-y-3">
                                        {alContracts.map(c => {
                                            const remainingQty = parseFloat(c.remainingQuantity);
                                            const totalQty = parseFloat(c.totalQuantity);
                                            const daysRemaining = calculateDaysRemaining(remainingQty, alAvgMonthlyUsage);
                                            const percentRemaining = (remainingQty / totalQty) * 100;
                                            
                                            // Calculate estimated completion date using working days
                                            const estimatedCompletionDate = calculateCompletionDate(remainingQty, alAvgMonthlyUsage);
                                            
                                            return (
                                                <div key={c.id} className="border rounded p-3">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <p className="font-semibold">{c.vendor}</p>
                                                            <p className="text-sm text-gray-600">${c.pricePerLb}/lb</p>
                                                        </div>
                                                        {alMarketPrice && (
                                                            <div className="text-right">
                                                                <p className="text-xs text-gray-500">vs Market</p>
                                                                <p className={`text-sm font-semibold ${parseFloat(c.pricePerLb) < alMarketPrice.total ? 'text-green-600' : 'text-red-600'}`}>
                                                                    {parseFloat(c.pricePerLb) < alMarketPrice.total ? 'â†“' : 'â†‘'} ${Math.abs(alMarketPrice.total - parseFloat(c.pricePerLb)).toFixed(4)}
                                                                </p>
                                                                <p className="text-xs text-gray-500">Mkt: ${alMarketPrice.total.toFixed(4)}</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-2 mb-1">
                                                        <div className="bg-blue-600 h-2 rounded-full" style={{width: `${percentRemaining}%`}}></div>
                                                    </div>
                                                    <div className="flex justify-between text-xs text-gray-600 mb-1">
                                                        <span>{remainingQty.toLocaleString()} lbs remain of {totalQty.toLocaleString()} lbs</span>
                                                        <span>
                                                            {daysRemaining !== null ? (
                                                                daysRemaining > 0 ? `~${daysRemaining} days` : 'Depleted'
                                                            ) : (
                                                                'No usage data'
                                                            )}
                                                        </span>
                                                    </div>
                                                    <div className="text-xs font-semibold text-green-700">
                                                        Current Stock: {inventory.aluminum5052.quantity.toLocaleString()} lbs
                                                    </div>
                                                    {estimatedCompletionDate && (
                                                        <div className="text-xs text-blue-700 font-semibold mt-1">
                                                            Est. Completion: {estimatedCompletionDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <p className="text-gray-500 text-center py-8">No active aluminum contracts</p>
                                )}
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4">Stainless 304 2B - Active Contracts</h3>
                                {ssContracts.length > 0 ? (
                                    <div className="space-y-3">
                                        {ssContracts.map(c => {
                                            const remainingQty = parseFloat(c.remainingQuantity);
                                            const totalQty = parseFloat(c.totalQuantity);
                                            const daysRemaining = calculateDaysRemaining(remainingQty, ssAvgMonthlyUsage);
                                            const percentRemaining = (remainingQty / totalQty) * 100;
                                            
                                            // Calculate estimated completion date using working days
                                            const estimatedCompletionDate = calculateCompletionDate(remainingQty, ssAvgMonthlyUsage);
                                            
                                            return (
                                                <div key={c.id} className="border rounded p-3">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <p className="font-semibold">{c.vendor}</p>
                                                            <p className="text-sm text-gray-600">${c.pricePerLb}/lb</p>
                                                        </div>
                                                        {ssMarketPrice && (
    								<div className="text-right">
        								<p className="text-xs text-gray-500">vs Market</p>
        								<p className={`text-sm font-semibold ${parseFloat(c.pricePerLb) < ssMarketPrice.total ? 'text-green-600' : 'text-red-600'}`}>
            									{parseFloat(c.pricePerLb) < ssMarketPrice.total ? 'â†“' : 'â†‘'} ${Math.abs(ssMarketPrice.total - parseFloat(c.pricePerLb)).toFixed(4)}
        								</p>
        								<p className="text-xs text-gray-500">Mkt: ${ssMarketPrice.total.toFixed(4)}</p>
    								</div>
							)}
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-2 mb-1">
                                                        <div className="bg-purple-600 h-2 rounded-full" style={{width: `${percentRemaining}%`}}></div>
                                                    </div>
                                                    <div className="flex justify-between text-xs text-gray-600 mb-1">
                                                        <span>{remainingQty.toLocaleString()} lbs remain of {totalQty.toLocaleString()} lbs</span>
                                                        <span>
                                                            {daysRemaining !== null ? (
                                                                daysRemaining > 0 ? `~${daysRemaining} days` : 'Depleted'
                                                            ) : (
                                                                'No usage data'
                                                            )}
                                                        </span>
                                                    </div>
                                                    <div className="text-xs font-semibold text-purple-700">
                                                        Current Stock: {inventory.stainless304.quantity.toLocaleString()} lbs
                                                    </div>
                                                    {estimatedCompletionDate && (
                                                        <div className="text-xs text-purple-700 font-semibold mt-1">
                                                            Est. Completion: {estimatedCompletionDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <p className="text-gray-500 text-center py-8">No active stainless contracts</p>
                                )}
                            </div>
                        </div>

                        {futureContracts.length > 0 && (
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <Clock size={20} />
                                    Future Contracts (Ordered, Awaiting Delivery)
                                </h3>
                                <div className="space-y-3">
                                    {futureContracts.map(c => {
                                        const daysUntilDelivery = Math.ceil((new Date(c.deliveryDate) - new Date()) / (1000 * 60 * 60 * 24));
                                        const isOverdue = daysUntilDelivery < 0;
                                        
                                        // Calculate projected end date for this future contract
                                        const avgUsage = c.material === 'aluminum5052' ? alAvgMonthlyUsage : ssAvgMonthlyUsage;
                                        const activeContract = contracts.find(contract => 
                                            contract.material === c.material && contract.status === 'active'
                                        );
                                        
                                        let projectedEndDate = null;
                                        let projectedStartDate = null;
                                        let contractDurationWeeks = null;
                                        
                                        if (avgUsage > 0) {
                                            // Use active contract remaining quantity (which IS the current stock)
                                            let runningTotal = 0;
                                            if (activeContract) {
                                                runningTotal = parseFloat(activeContract.remainingQuantity || 0);
                                            }
                                            
                                            // Active contract depletes, then this future contract starts
                                            const monthsUntilStart = runningTotal / avgUsage;
                                            projectedStartDate = new Date();
                                            projectedStartDate.setMonth(projectedStartDate.getMonth() + monthsUntilStart);
                                            
                                            // Calculate how long THIS contract will last
                                            const futureQty = parseFloat(c.totalQuantity);
                                            const monthsThisContractLasts = futureQty / avgUsage;
                                            contractDurationWeeks = Math.round(monthsThisContractLasts * 4.33); // Convert months to weeks
                                            
                                            // Add this contract's quantity to running total for end date
                                            runningTotal += futureQty;
                                            const monthsUntilEnd = runningTotal / avgUsage;
                                            projectedEndDate = new Date();
                                            projectedEndDate.setMonth(projectedEndDate.getMonth() + monthsUntilEnd);
                                        }
                                        
                                        return (
                                            <div key={c.id} className="border rounded p-3 bg-orange-50">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="font-semibold">{c.vendor}</span>
                                                            <span className="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded">
                                                                {c.material === 'aluminum5052' ? 'Aluminum 5052' : 'Stainless 304 2B'}
                                                            </span>
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            <span className="font-medium">${c.pricePerLb}/lb</span>
                                                            <span className="mx-2">â€¢</span>
                                                            <span>{parseFloat(c.totalQuantity).toLocaleString()} lbs</span>
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            Ordered: {c.orderDate} â€¢ Delivery: {c.deliveryDate}
                                                        </div>
                                                        {projectedStartDate && projectedEndDate && (
                                                            <div className="text-xs mt-2 pt-2 border-t border-orange-200">
                                                                <div className="font-medium text-orange-700">Projected Timeline:</div>
                                                                <div className="text-gray-600">
                                                                    Start using: ~{projectedStartDate.toISOString().substring(0, 7)}
                                                                </div>
                                                                <div className="text-gray-600">
                                                                    Est. depleted: ~{projectedEndDate.toISOString().substring(0, 7)}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {avgUsage === 0 && (
                                                            <div className="text-xs mt-2 pt-2 border-t border-orange-200 text-gray-500">
                                                                Log usage data to see projections
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="text-right">
                                                        {contractDurationWeeks !== null ? (
                                                            <>
                                                                <div className="text-lg font-bold text-green-700">
                                                                    ~{contractDurationWeeks} weeks
                                                                </div>
                                                                <div className="text-xs text-gray-500">
                                                                    Contract duration
                                                                </div>
                                                                <div className="text-xs text-gray-500 mt-1">
                                                                    ({Math.round(contractDurationWeeks / 4.33)} months)
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div className="text-sm font-semibold text-orange-600">
                                                                    {parseFloat(c.totalQuantity).toLocaleString()} lbs
                                                                </div>
                                                                <div className="text-xs text-gray-500">
                                                                    No usage data
                                                                </div>
                                                            </>
                                                        )}
                                                        <button
                                                            onClick={() => {
                                                                setEditingContract(c);
                                                                setShowContractForm(true);
                                                            }}
                                                            className="text-xs text-blue-600 hover:text-blue-800 mt-2 block"
                                                        >
                                                            Mark as Received
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {usageChartData.length > 0 && typeof ResponsiveContainer !== 'undefined' && (
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h3 className="text-lg font-semibold mb-4">Monthly Usage Trend</h3>
                                <ResponsiveContainer width="100%" height={300}>
                                    <BarChart data={usageChartData}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis dataKey="month" />
                                        <YAxis />
                                        <Tooltip />
                                        <Legend />
                                        <Bar dataKey="Aluminum" fill="#3b82f6" />
                                        <Bar dataKey="Stainless" fill="#a855f7" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        )}
			{marketPrices.length > 0 && typeof ResponsiveContainer !== 'undefined' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-lg font-semibold mb-4">Aluminum 5052 - Market vs Our Cost</h3>
                                    <ResponsiveContainer width="100%" height={300}>
                                        <LineChart data={marketPrices.slice(0, 10).reverse().map(p => {
    // Calculate market price for THIS specific date's data
    const alBase = parseFloat(p.aluminumBase) || 0;
    const midwest = parseFloat(p.midwestPremium) || 0;
    const marketTotal = alBase + midwest;
    
    return {
        date: p.date,
        'Market Price': marketTotal > 0 ? marketTotal : null,
        'Our Cost': p.ourAluminumCost ? parseFloat(p.ourAluminumCost) : null
    };
})}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis dataKey="date" tick={{ fontSize: 11 }} angle={-45} textAnchor="end" height={60} />
                                            <YAxis label={{ value: '$/lb', angle: -90, position: 'insideLeft' }} domain={[2.0, 4.0]} />
                                            <Tooltip />
                                            <Legend />
                                            <Line type="monotone" dataKey="Market Price" stroke="#3b82f6" strokeWidth={2} dot={{ r: 3 }} />
                                            <Line type="monotone" dataKey="Our Cost" stroke="#10b981" strokeWidth={2} strokeDasharray="5 5" dot={{ r: 3 }} />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>

                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-lg font-semibold mb-4">Stainless Steel 304 2B - Market vs Our Cost</h3>
                                    <ResponsiveContainer width="100%" height={300}>
                                      <LineChart data={marketPrices.slice(0, 10).reverse().map(p => {
    // Calculate market price for THIS specific date's data
    const priceDate = new Date(p.date);
    const fetchStartDate = new Date('2025-11-19');
    
    let marketTotal = 0;
    
    if (priceDate >= fetchStartDate) {
        // NEW ENTRIES (11/19/25 and later) - Use full formula
        const nickelPerLb = parseFloat(p.nickel) || 0;
        const chromePerLb = parseFloat(p.chrome) || 0;
        const scrapIronPerLb = parseFloat(p.scrapIron) || 0;
        const conversionPricing = parseFloat(p.conversionPricing) || 0;
        
        const nickelComponent = ((nickelPerLb / 2) * 1.2) * 0.08;
        const chromeComponent = (chromePerLb - 0.35) * 0.18 * 1.2;
        const scrapIronComponent = (((scrapIronPerLb * 2240) - 140) / 2240) * 0.719;
        marketTotal = nickelComponent + chromeComponent + scrapIronComponent + conversionPricing;
    } else {
        // HISTORICAL ENTRIES (before 11/19/25) - Simple addition
        const nickel = parseFloat(p.nickel) || 0;
        const chrome = parseFloat(p.chrome) || 0;
        const scrapIron = parseFloat(p.scrapIron) || 0;
        const conversion = parseFloat(p.conversionPricing) || 0;
        marketTotal = nickel + chrome + scrapIron + conversion;
    }
    
    return {
        date: p.date,
        'Market Price': marketTotal > 0 ? marketTotal : null,
        'Our Cost': p.ourStainlessCost ? parseFloat(p.ourStainlessCost) : null
    };
})}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis dataKey="date" tick={{ fontSize: 11 }} angle={-45} textAnchor="end" height={60} />
                                            <YAxis label={{ value: '$/lb', angle: -90, position: 'insideLeft' }} domain={[1.2, 2.3]} />
                                            <Tooltip />
                                            <Legend />
                                            <Line type="monotone" dataKey="Market Price" stroke="#a855f7" strokeWidth={2} dot={{ r: 3 }} />
                                            <Line type="monotone" dataKey="Our Cost" stroke="#10b981" strokeWidth={2} strokeDasharray="5 5" dot={{ r: 3 }} />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };
 
             const ContractsView = () => {
                return (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Contracts</h2>
                            <button
                                onClick={() => {
                                    setEditingContract(null);
                                    setShowContractForm(true);
                                }}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                <Plus size={20} />
                                Add Contract
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Material</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price/lb</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Delivery</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {contracts.map(contract => (
                                        <tr key={contract.id}>
                                            <td className="px-6 py-4">
                                                {contract.material === 'aluminum5052' ? 'Aluminum 5052' : 'Stainless 304 2B'}
                                            </td>
                                            <td className="px-6 py-4">{contract.vendor}</td>
                                            <td className="px-6 py-4">${contract.pricePerLb}</td>
                                            <td className="px-6 py-4">
                                                {contract.status === 'active' 
                                                    ? `${parseFloat(contract.remainingQuantity).toLocaleString()} / ${parseFloat(contract.totalQuantity).toLocaleString()} lbs`
                                                    : `${parseFloat(contract.totalQuantity).toLocaleString()} lbs`
                                                }
                                            </td>
                                            <td className="px-6 py-4">{contract.deliveryDate}</td>
                                            <td className="px-6 py-4">
                                                <span className={`px-2 py-1 rounded text-xs ${
                                                    contract.status === 'active' ? 'bg-green-100 text-green-800' : 
                                                    contract.status === 'future' ? 'bg-orange-100 text-orange-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`}>
                                                    {contract.status}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4">
                                                <button
                                                    onClick={() => {
                                                        setEditingContract(contract);
                                                        setShowContractForm(true);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-800 text-sm"
                                                >
                                                    Edit
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {contracts.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    No contracts yet. Click "Add Contract" to get started.
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const UsageView = () => {
                // Calculate average monthly usage for each material
                const calculateAverageUsage = (material) => {
                    const materialUsage = usageHistory.filter(u => u.material === material);
                    if (materialUsage.length === 0) return 0;
                    const total = materialUsage.reduce((sum, u) => sum + parseFloat(u.quantity), 0);
                    return total / materialUsage.length;
                };

                const alAvgUsage = calculateAverageUsage('aluminum5052');
                const ssAvgUsage = calculateAverageUsage('stainless304');

                // Calculate projected contract end dates
                const calculateContractProjections = (material) => {
                    const avgUsage = material === 'aluminum5052' ? alAvgUsage : ssAvgUsage;
                    if (avgUsage === 0) return [];

                    const currentStock = material === 'aluminum5052' ? inventory.aluminum5052.quantity : inventory.stainless304.quantity;
                    const allContracts = contracts
                        .filter(c => c.material === material && (c.status === 'active' || c.status === 'future'))
                        .sort((a, b) => {
                            // Sort: active first, then by delivery date
                            if (a.status === 'active' && b.status !== 'active') return -1;
                            if (a.status !== 'active' && b.status === 'active') return 1;
                            return new Date(a.deliveryDate) - new Date(b.deliveryDate);
                        });

                    let runningTotal = currentStock;
                    const projections = [];

                    allContracts.forEach(contract => {
                        const contractQty = parseFloat(contract.remainingQuantity || contract.totalQuantity);
                        runningTotal += contractQty;
                        const monthsUntilEnd = runningTotal / avgUsage;
                        const endDate = new Date();
                        endDate.setMonth(endDate.getMonth() + monthsUntilEnd);
                        
                        projections.push({
                            vendor: contract.vendor,
                            status: contract.status,
                            quantity: contractQty,
                            projectedEndDate: endDate.toISOString().substring(0, 7), // YYYY-MM
                            monthsFromNow: Math.ceil(monthsUntilEnd)
                        });
                    });

                    return projections;
                };

                const alProjections = calculateContractProjections('aluminum5052');
                const ssProjections = calculateContractProjections('stainless304');

                return (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Monthly Usage History</h2>
                            <button
                                onClick={() => {
                                    setEditingUsage(null);
                                    setShowUsageForm(true);
                                }}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                <Plus size={20} />
                                Log Monthly Usage
                            </button>
                        </div>

                        {/* Usage Statistics */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h3 className="font-semibold text-blue-900 mb-2">Aluminum 5052 Average Usage</h3>
                                <p className="text-2xl font-bold text-blue-700">{alAvgUsage.toLocaleString(undefined, {maximumFractionDigits: 0})} lbs/month</p>
                                <p className="text-xs text-blue-600 mt-1">Based on {usageHistory.filter(u => u.material === 'aluminum5052').length} months of data</p>
                            </div>
                            <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <h3 className="font-semibold text-purple-900 mb-2">Stainless 304 2B Average Usage</h3>
                                <p className="text-2xl font-bold text-purple-700">{ssAvgUsage.toLocaleString(undefined, {maximumFractionDigits: 0})} lbs/month</p>
                                <p className="text-xs text-purple-600 mt-1">Based on {usageHistory.filter(u => u.material === 'stainless304').length} months of data</p>
                            </div>
                        </div>

                        {/* Contract Projections */}
                        {(alProjections.length > 0 || ssProjections.length > 0) && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {alProjections.length > 0 && (
                                    <div className="bg-white p-4 rounded-lg shadow">
                                        <h3 className="font-semibold mb-3">Aluminum Contract Projections</h3>
                                        <div className="space-y-2">
                                            {alProjections.map((proj, idx) => (
                                                <div key={idx} className="text-sm border-l-4 border-blue-500 pl-3 py-1">
                                                    <div className="font-medium">{proj.vendor} {proj.status === 'future' && '(Future)'}</div>
                                                    <div className="text-gray-600">
                                                        {proj.quantity.toLocaleString()} lbs â†’ Est. end: <span className="font-semibold">{proj.projectedEndDate}</span>
                                                    </div>
                                                    <div className="text-xs text-gray-500">~{proj.monthsFromNow} months from now</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {ssProjections.length > 0 && (
                                    <div className="bg-white p-4 rounded-lg shadow">
                                        <h3 className="font-semibold mb-3">Stainless Contract Projections</h3>
                                        <div className="space-y-2">
                                            {ssProjections.map((proj, idx) => (
                                                <div key={idx} className="text-sm border-l-4 border-purple-500 pl-3 py-1">
                                                    <div className="font-medium">{proj.vendor} {proj.status === 'future' && '(Future)'}</div>
                                                    <div className="text-gray-600">
                                                        {proj.quantity.toLocaleString()} lbs â†’ Est. end: <span className="font-semibold">{proj.projectedEndDate}</span>
                                                    </div>
                                                    <div className="text-xs text-gray-500">~{proj.monthsFromNow} months from now</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Usage History Table */}
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Material</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {usageHistory.map(usage => (
                                        <tr key={usage.id}>
                                            <td className="px-6 py-4">{usage.month}</td>
                                            <td className="px-6 py-4">
                                                {usage.material === 'aluminum5052' ? 'Aluminum 5052' : 'Stainless 304 2B'}
                                            </td>
                                            <td className="px-6 py-4">{parseFloat(usage.quantity).toLocaleString()} lbs</td>
                                            <td className="px-6 py-4 text-sm text-gray-600">{usage.notes || '-'}</td>
                                            <td className="px-6 py-4">
                                                <button
                                                    onClick={() => {
                                                        setEditingUsage(usage);
                                                        setShowUsageForm(true);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-800 text-sm"
                                                >
                                                    Edit
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {usageHistory.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    No usage recorded yet. Click "Log Monthly Usage" to get started.
                                </div>
                            )}
                        </div>
                    </div>
                );
            };
            // Scrap Contract Form Component
            const ScrapContractForm = ({ onClose, onSubmit, initialData = null }) => {
                const [formData, setFormData] = useState(initialData || {
                    id: Date.now(),
                    site: 'woodinville',
                    vendor: '',
                    aluminum5052Price: '',
                    stainless304Price: '',
                    steelCRSPrice: '',
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: '',
                    notes: '',
                    status: 'active'
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">
                                    {initialData ? 'Edit Scrap Contract' : 'Add Scrap Contract'}
                                </h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Site Location</label>
                                            <select
                                                value={formData.site}
                                                onChange={(e) => setFormData({...formData, site: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            >
                                                <option value="woodinville">Woodinville</option>
                                                <option value="spokane">Spokane</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Status</label>
                                            <select
                                                value={formData.status}
                                                onChange={(e) => setFormData({...formData, status: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                            >
                                                <option value="active">Active</option>
                                                <option value="expired">Expired</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Vendor Name</label>
                                        <input
                                            type="text"
                                            value={formData.vendor}
                                            onChange={(e) => setFormData({...formData, vendor: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="border-t pt-4">
                                        <h3 className="font-semibold mb-3">Scrap Pricing ($/lb)</h3>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Aluminum 5052</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.aluminum5052Price}
                                                    onChange={(e) => setFormData({...formData, aluminum5052Price: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                    placeholder="0.0000"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Stainless 304</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.stainless304Price}
                                                    onChange={(e) => setFormData({...formData, stainless304Price: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                    placeholder="0.0000"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Steel CRS</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.steelCRSPrice}
                                                    onChange={(e) => setFormData({...formData, steelCRSPrice: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                    placeholder="0.0000"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Contract Start Date</label>
                                            <input
                                                type="date"
                                                value={formData.startDate}
                                                onChange={(e) => setFormData({...formData, startDate: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Contract End Date</label>
                                            <input
                                                type="date"
                                                value={formData.endDate}
                                                onChange={(e) => setFormData({...formData, endDate: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Notes</label>
                                        <textarea
                                            value={formData.notes}
                                            onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            rows="3"
                                            placeholder="Any additional contract details or terms"
                                        />
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            {initialData ? 'Update Contract' : 'Add Contract'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            // Scrap Bid Form Component
            const ScrapBidForm = ({ onClose, onSubmit, site, initialData = null }) => {
                const [formData, setFormData] = useState(initialData || {
                    id: Date.now(),
                    site: site,
                    vendor: '',
                    aluminum5052Price: '',
                    stainless304Price: '',
                    steelCRSPrice: '',
                    receivedDate: new Date().toISOString().split('T')[0],
                    validUntil: '',
                    notes: ''
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">
                                    {initialData ? 'Edit Scrap Bid' : `Add Scrap Bid - ${site === 'woodinville' ? 'Woodinville' : 'Spokane'}`}
                                </h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Vendor Name</label>
                                        <input
                                            type="text"
                                            value={formData.vendor}
                                            onChange={(e) => setFormData({...formData, vendor: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />
                                    </div>

                                    <div className="border-t pt-4">
                                        <h3 className="font-semibold mb-3">Bid Pricing ($/lb)</h3>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Aluminum 5052</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.aluminum5052Price}
                                                    onChange={(e) => setFormData({...formData, aluminum5052Price: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                    placeholder="0.0000"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Stainless 304</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.stainless304Price}
                                                    onChange={(e) => setFormData({...formData, stainless304Price: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                    placeholder="0.0000"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Steel CRS</label>
                                                <input
                                                    type="number"
                                                    step="0.0001"
                                                    value={formData.steelCRSPrice}
                                                    onChange={(e) => setFormData({...formData, steelCRSPrice: e.target.value})}
                                                    className="w-full border rounded px-3 py-2"
                                                    placeholder="0.0000"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Bid Received Date</label>
                                            <input
                                                type="date"
                                                value={formData.receivedDate}
                                                onChange={(e) => setFormData({...formData, receivedDate: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Valid Until</label>
                                            <input
                                                type="date"
                                                value={formData.validUntil}
                                                onChange={(e) => setFormData({...formData, validUntil: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Notes</label>
                                        <textarea
                                            value={formData.notes}
                                            onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            rows="3"
                                            placeholder="Any special terms, conditions, or notes about this bid"
                                        />
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            {initialData ? 'Update Bid' : 'Add Bid'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            // Weight Ticket Form Component
            const WeightTicketForm = ({ onClose, onSubmit, site, initialData = null }) => {
                const [formData, setFormData] = useState(initialData || {
                    id: Date.now(),
                    site: site,
                    supplier: '',
                    date: new Date().toISOString().split('T')[0],
                    controlNumber: '',
                    commodity: '',
                    description: '',
                    grossWeight: '',
                    netWeight: '',
                    price: '',
                    unitOfMeasure: 'lbs',
                    totalAmount: ''
                });

                // Auto-calculate total amount when price or net weight changes
                useEffect(() => {
                    if (formData.price && formData.netWeight) {
                        const total = (parseFloat(formData.price) * parseFloat(formData.netWeight)).toFixed(2);
                        setFormData(prev => ({...prev, totalAmount: total}));
                    }
                }, [formData.price, formData.netWeight]);

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSubmit(formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4">
                                    {initialData ? 'Edit Weight Ticket' : `Add Weight Ticket - ${site === 'woodinville' ? 'Woodinville' : 'Spokane'}`}
                                </h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Supplier</label>
                                            <input
                                                type="text"
                                                value={formData.supplier}
                                                onChange={(e) => setFormData({...formData, supplier: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Date</label>
                                            <input
                                                type="date"
                                                value={formData.date}
                                                onChange={(e) => setFormData({...formData, date: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                required
                                            />
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Control #</label>
                                            <input
                                                type="text"
                                                value={formData.controlNumber}
                                                onChange={(e) => setFormData({...formData, controlNumber: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                placeholder="Ticket control number"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Commodity</label>
                                            <input
                                                type="text"
                                                value={formData.commodity}
                                                onChange={(e) => setFormData({...formData, commodity: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                placeholder="e.g., Aluminum, Stainless, Steel"
                                                required
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Description</label>
                                        <input
                                            type="text"
                                            value={formData.description}
                                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                                            className="w-full border rounded px-3 py-2"
                                            placeholder="Detailed description of material"
                                        />
                                    </div>

                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Gross Weight</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.grossWeight}
                                                onChange={(e) => setFormData({...formData, grossWeight: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                placeholder="0.00"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Net Weight</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.netWeight}
                                                onChange={(e) => setFormData({...formData, netWeight: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                placeholder="0.00"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Unit of Measure</label>
                                            <select
                                                value={formData.unitOfMeasure}
                                                onChange={(e) => setFormData({...formData, unitOfMeasure: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                            >
                                                <option value="lbs">lbs</option>
                                                <option value="tons">tons</option>
                                                <option value="kg">kg</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Price per Unit ($)</label>
                                            <input
                                                type="number"
                                                step="0.0001"
                                                value={formData.price}
                                                onChange={(e) => setFormData({...formData, price: e.target.value})}
                                                className="w-full border rounded px-3 py-2"
                                                placeholder="0.0000"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Total Amount ($)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.totalAmount}
                                                onChange={(e) => setFormData({...formData, totalAmount: e.target.value})}
                                                className="w-full border rounded px-3 py-2 bg-gray-100"
                                                placeholder="Auto-calculated"
                                                readOnly
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Auto-calculated from price Ã— net weight</p>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-2 pt-4">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 border rounded hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            {initialData ? 'Update Ticket' : 'Add Ticket'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            // Scrap Management View
            const ScrapView = () => {
                const activeScrapContracts = scrapContracts.filter(c => c.status === 'active');
                const woodinvilleContract = activeScrapContracts.find(c => c.site === 'woodinville');
                const spokaneContract = activeScrapContracts.find(c => c.site === 'spokane');

                const woodinvilleBids = scrapBids.filter(b => b.site === 'woodinville').sort((a, b) => new Date(b.receivedDate) - new Date(a.receivedDate));
                const spokaneBids = scrapBids.filter(b => b.site === 'spokane').sort((a, b) => new Date(b.receivedDate) - new Date(a.receivedDate));

                const convertBidToContract = (bid) => {
                    if (confirm(`Convert this bid from ${bid.vendor} to a scrap contract for ${bid.site === 'woodinville' ? 'Woodinville' : 'Spokane'}?`)) {
                        const newContract = {
                            id: Date.now(),
                            site: bid.site,
                            vendor: bid.vendor,
                            aluminum5052Price: bid.aluminum5052Price,
                            stainless304Price: bid.stainless304Price,
                            steelCRSPrice: bid.steelCRSPrice,
                            startDate: new Date().toISOString().split('T')[0],
                            endDate: bid.validUntil || '',
                            notes: `Converted from bid on ${bid.receivedDate}. ${bid.notes || ''}`,
                            status: 'active'
                        };
                        setScrapContracts([...scrapContracts, newContract]);
                        alert('Scrap contract created successfully!');
                    }
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold flex items-center gap-2">
                                <Recycle size={28} />
                                Scrap Management
                            </h2>
                            <button
                                onClick={() => {
                                    setEditingScrapContract(null);
                                    setShowScrapContractForm(true);
                                }}
                                className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                            >
                                <Plus size={20} />
                                Add Scrap Contract
                            </button>
                        </div>

                        {/* Current Contracts Section */}
                        <div>
                            <h3 className="text-xl font-semibold mb-4">Current Scrap Contracts</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* Woodinville Contract */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h4 className="text-lg font-semibold text-blue-900">Woodinville Site</h4>
                                            {woodinvilleContract ? (
                                                <p className="text-sm text-gray-600">{woodinvilleContract.vendor}</p>
                                            ) : (
                                                <p className="text-sm text-gray-500 italic">No active contract</p>
                                            )}
                                        </div>
                                        {woodinvilleContract && (
                                            <button
                                                onClick={() => {
                                                    setEditingScrapContract(woodinvilleContract);
                                                    setShowScrapContractForm(true);
                                                }}
                                                className="text-blue-600 hover:text-blue-800 text-sm"
                                            >
                                                Edit
                                            </button>
                                        )}
                                    </div>
                                    {woodinvilleContract ? (
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-sm border-b pb-2">
                                                <span className="text-gray-600">Aluminum 5052:</span>
                                                <span className="font-semibold">${woodinvilleContract.aluminum5052Price || 'N/A'}/lb</span>
                                            </div>
                                            <div className="flex justify-between text-sm border-b pb-2">
                                                <span className="text-gray-600">Stainless 304:</span>
                                                <span className="font-semibold">${woodinvilleContract.stainless304Price || 'N/A'}/lb</span>
                                            </div>
                                            <div className="flex justify-between text-sm border-b pb-2">
                                                <span className="text-gray-600">Steel CRS:</span>
                                                <span className="font-semibold">${woodinvilleContract.steelCRSPrice || 'N/A'}/lb</span>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-3">
                                                Contract: {woodinvilleContract.startDate} {woodinvilleContract.endDate && `to ${woodinvilleContract.endDate}`}
                                            </div>
                                            {woodinvilleContract.notes && (
                                                <div className="text-xs text-gray-600 mt-2">
                                                    <strong>Notes:</strong> {woodinvilleContract.notes}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <p className="text-sm text-gray-500 text-center py-8">
                                            No active scrap contract for Woodinville
                                        </p>
                                    )}
                                </div>

                                {/* Spokane Contract */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h4 className="text-lg font-semibold text-purple-900">Spokane Site</h4>
                                            {spokaneContract ? (
                                                <p className="text-sm text-gray-600">{spokaneContract.vendor}</p>
                                            ) : (
                                                <p className="text-sm text-gray-500 italic">No active contract</p>
                                            )}
                                        </div>
                                        {spokaneContract && (
                                            <button
                                                onClick={() => {
                                                    setEditingScrapContract(spokaneContract);
                                                    setShowScrapContractForm(true);
                                                }}
                                                className="text-blue-600 hover:text-blue-800 text-sm"
                                            >
                                                Edit
                                            </button>
                                        )}
                                    </div>
                                    {spokaneContract ? (
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-sm border-b pb-2">
                                                <span className="text-gray-600">Aluminum 5052:</span>
                                                <span className="font-semibold">${spokaneContract.aluminum5052Price || 'N/A'}/lb</span>
                                            </div>
                                            <div className="flex justify-between text-sm border-b pb-2">
                                                <span className="text-gray-600">Stainless 304:</span>
                                                <span className="font-semibold">${spokaneContract.stainless304Price || 'N/A'}/lb</span>
                                            </div>
                                            <div className="flex justify-between text-sm border-b pb-2">
                                                <span className="text-gray-600">Steel CRS:</span>
                                                <span className="font-semibold">${spokaneContract.steelCRSPrice || 'N/A'}/lb</span>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-3">
                                                Contract: {spokaneContract.startDate} {spokaneContract.endDate && `to ${spokaneContract.endDate}`}
                                            </div>
                                            {spokaneContract.notes && (
                                                <div className="text-xs text-gray-600 mt-2">
                                                    <strong>Notes:</strong> {spokaneContract.notes}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <p className="text-sm text-gray-500 text-center py-8">
                                            No active scrap contract for Spokane
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Bids Section */}
                        <div>
                            <h3 className="text-xl font-semibold mb-4">Scrap Bids by Site</h3>
                            
                            {/* Woodinville Bids */}
                            <div className="bg-white rounded-lg shadow mb-4">
                                <button
                                    onClick={() => setExpandedSite(expandedSite === 'woodinville' ? null : 'woodinville')}
                                    className="w-full px-6 py-4 flex justify-between items-center hover:bg-gray-50"
                                >
                                    <div className="flex items-center gap-3">
                                        {expandedSite === 'woodinville' ? <ChevronDown /> : <ChevronRight />}
                                        <h4 className="text-lg font-semibold text-blue-900">Woodinville Bids ({woodinvilleBids.length})</h4>
                                    </div>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setEditingScrapBid(null);
                                            setShowScrapBidForm('woodinville');
                                        }}
                                        className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                                    >
                                        <Plus size={16} />
                                        Add Bid
                                    </button>
                                </button>
                                
                                {expandedSite === 'woodinville' && (
                                    <div className="px-6 pb-6 space-y-3">
                                        {woodinvilleBids.length > 0 ? (
                                            woodinvilleBids.map(bid => (
                                                <div key={bid.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <h5 className="font-semibold text-lg">{bid.vendor}</h5>
                                                            <p className="text-xs text-gray-500">Received: {bid.receivedDate}</p>
                                                            {bid.validUntil && (
                                                                <p className="text-xs text-gray-500">Valid until: {bid.validUntil}</p>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => convertBidToContract(bid)}
                                                                className="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700"
                                                            >
                                                                Convert to Contract
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    setEditingScrapBid(bid);
                                                                    setShowScrapBidForm('woodinville');
                                                                }}
                                                                className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                                                            >
                                                                Edit
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    if (confirm('Delete this bid?')) {
                                                                        setScrapBids(scrapBids.filter(b => b.id !== bid.id));
                                                                    }
                                                                }}
                                                                className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                                        <div>
                                                            <span className="text-gray-600">Aluminum 5052:</span>
                                                            <p className="font-semibold text-blue-700">${bid.aluminum5052Price || 'N/A'}/lb</p>
                                                        </div>
                                                        <div>
                                                            <span className="text-gray-600">Stainless 304:</span>
                                                            <p className="font-semibold text-blue-700">${bid.stainless304Price || 'N/A'}/lb</p>
                                                        </div>
                                                        <div>
                                                            <span className="text-gray-600">Steel CRS:</span>
                                                            <p className="font-semibold text-blue-700">${bid.steelCRSPrice || 'N/A'}/lb</p>
                                                        </div>
                                                    </div>
                                                    {bid.notes && (
                                                        <div className="mt-3 text-sm text-gray-600 border-t pt-2">
                                                            <strong>Notes:</strong> {bid.notes}
                                                        </div>
                                                    )}
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-gray-500 text-center py-8">No bids yet for Woodinville</p>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Spokane Bids */}
                            <div className="bg-white rounded-lg shadow">
                                <button
                                    onClick={() => setExpandedSite(expandedSite === 'spokane' ? null : 'spokane')}
                                    className="w-full px-6 py-4 flex justify-between items-center hover:bg-gray-50"
                                >
                                    <div className="flex items-center gap-3">
                                        {expandedSite === 'spokane' ? <ChevronDown /> : <ChevronRight />}
                                        <h4 className="text-lg font-semibold text-purple-900">Spokane Bids ({spokaneBids.length})</h4>
                                    </div>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setEditingScrapBid(null);
                                            setShowScrapBidForm('spokane');
                                        }}
                                        className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700"
                                    >
                                        <Plus size={16} />
                                        Add Bid
                                    </button>
                                </button>
                                
                                {expandedSite === 'spokane' && (
                                    <div className="px-6 pb-6 space-y-3">
                                        {spokaneBids.length > 0 ? (
                                            spokaneBids.map(bid => (
                                                <div key={bid.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <h5 className="font-semibold text-lg">{bid.vendor}</h5>
                                                            <p className="text-xs text-gray-500">Received: {bid.receivedDate}</p>
                                                            {bid.validUntil && (
                                                                <p className="text-xs text-gray-500">Valid until: {bid.validUntil}</p>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => convertBidToContract(bid)}
                                                                className="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700"
                                                            >
                                                                Convert to Contract
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    setEditingScrapBid(bid);
                                                                    setShowScrapBidForm('spokane');
                                                                }}
                                                                className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                                                            >
                                                                Edit
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    if (confirm('Delete this bid?')) {
                                                                        setScrapBids(scrapBids.filter(b => b.id !== bid.id));
                                                                    }
                                                                }}
                                                                className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                                        <div>
                                                            <span className="text-gray-600">Aluminum 5052:</span>
                                                            <p className="font-semibold text-purple-700">${bid.aluminum5052Price || 'N/A'}/lb</p>
                                                        </div>
                                                        <div>
                                                            <span className="text-gray-600">Stainless 304:</span>
                                                            <p className="font-semibold text-purple-700">${bid.stainless304Price || 'N/A'}/lb</p>
                                                        </div>
                                                        <div>
                                                            <span className="text-gray-600">Steel CRS:</span>
                                                            <p className="font-semibold text-purple-700">${bid.steelCRSPrice || 'N/A'}/lb</p>
                                                        </div>
                                                    </div>
                                                    {bid.notes && (
                                                        <div className="mt-3 text-sm text-gray-600 border-t pt-2">
                                                            <strong>Notes:</strong> {bid.notes}
                                                        </div>
                                                    )}
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-gray-500 text-center py-8">No bids yet for Spokane</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

const GraphsView = () => {
    const [timePeriod, setTimePeriod] = useState('90day');
    const [aluminumData, setAluminumData] = useState([]);
    const [stainlessData, setStainlessData] = useState([]);
    const [alFloor, setAlFloor] = useState(null);
    const [alCeiling, setAlCeiling] = useState(null);
    const [ssFloor, setSsFloor] = useState(null);
    const [ssCeiling, setSsCeiling] = useState(null);

    useEffect(() => {
        prepareGraphData();
    }, [contracts, marketPrices, timePeriod]);

    const prepareGraphData = () => {
        const now = new Date();
        let daysToShow = 90;
        
        switch(timePeriod) {
            case '10day': daysToShow = 10; break;
            case '30day': daysToShow = 30; break;
            case '90day': daysToShow = 90; break;
            case '1year': daysToShow = 365; break;
        }

        const cutoffDate = new Date(now.getTime() - (daysToShow * 24 * 60 * 60 * 1000));

        // Filter market prices within time period
        const relevantPrices = marketPrices
            .filter(p => new Date(p.date) >= cutoffDate)
            .sort((a, b) => new Date(a.date) - new Date(b.date));

        // Prepare Aluminum data
        const alData = [];
        const alContractPrices = [];
        
        relevantPrices.forEach(price => {
            const marketPrice = calculateMarketPrice('aluminum5052');
            if (marketPrice) {
                const dataPoint = {
                    date: price.date,
                    market: marketPrice.total,
                    ourCost: price.ourAluminumCost ? parseFloat(price.ourAluminumCost) : null
                };

                // Add contract prices that were active on this date
                contracts
                    .filter(c => c.material === 'aluminum5052' && c.status !== 'completed')
                    .forEach((contract) => {
                        const contractDate = new Date(contract.deliveryDate);
                        const priceDate = new Date(price.date);
                        
                        if (contractDate <= priceDate || contract.status === 'active') {
                            dataPoint[`${contract.vendor}`] = parseFloat(contract.pricePerLb);
                            alContractPrices.push(parseFloat(contract.pricePerLb));
                        }
                    });

                alData.push(dataPoint);
            }
        });

        // Calculate floor and ceiling for aluminum
        const alMarketPrices = alData.map(d => d.market).filter(p => p);
        if (alMarketPrices.length > 0 && alContractPrices.length > 0) {
            setAlFloor(Math.min(...alContractPrices));
            setAlCeiling(Math.max(...alMarketPrices));
        } else {
            setAlFloor(null);
            setAlCeiling(null);
        }

        setAluminumData(alData);

        // Prepare Stainless data
        const ssData = [];
        const ssContractPrices = [];
        
        relevantPrices.forEach(price => {
            const marketPrice = calculateMarketPrice('stainless304');
            if (marketPrice) {
                const dataPoint = {
                    date: price.date,
                    market: marketPrice.total,
                    ourCost: price.ourStainlessCost ? parseFloat(price.ourStainlessCost) : null
                };

                contracts
                    .filter(c => c.material === 'stainless304' && c.status !== 'completed')
                    .forEach((contract) => {
                        const contractDate = new Date(contract.deliveryDate);
                        const priceDate = new Date(price.date);
                        
                        if (contractDate <= priceDate || contract.status === 'active') {
                            dataPoint[`${contract.vendor}`] = parseFloat(contract.pricePerLb);
                            ssContractPrices.push(parseFloat(contract.pricePerLb));
                        }
                    });

                ssData.push(dataPoint);
            }
        });

        // Calculate floor and ceiling for stainless
        const ssMarketPrices = ssData.map(d => d.market).filter(p => p);
        if (ssMarketPrices.length > 0 && ssContractPrices.length > 0) {
            setSsFloor(Math.min(...ssContractPrices));
            setSsCeiling(Math.max(...ssMarketPrices));
        } else {
            setSsFloor(null);
            setSsCeiling(null);
        }

        setStainlessData(ssData);
    };

    const getAluminumVendors = () => {
        return [...new Set(
            contracts
                .filter(c => c.material === 'aluminum5052' && c.status !== 'completed')
                .map(c => c.vendor)
        )];
    };

    const getStainlessVendors = () => {
        return [...new Set(
            contracts
                .filter(c => c.material === 'stainless304' && c.status !== 'completed')
                .map(c => c.vendor)
        )];
    };

    const contractColors = [
        '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899', '#14b8a6'
    ];

    const CustomTooltip = ({ active, payload, label }) => {
        if (active && payload && payload.length) {
            return (
                <div className="bg-white p-3 border border-gray-300 rounded shadow-lg">
                    <p className="font-semibold mb-2">{label}</p>
                    {payload.map((entry, index) => (
                        <p key={index} style={{ color: entry.color }} className="text-sm">
                            {entry.name}: ${entry.value?.toFixed(4)}/lb
                        </p>
                    ))}
                </div>
            );
        }
        return null;
    };

    if (typeof ResponsiveContainer === 'undefined') {
        return (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                <p className="text-yellow-800">Charts library not loaded. Please refresh the page.</p>
            </div>
        );
    }

    return (
        <div className="space-y-6">
            {/* Header with Time Period Filters */}
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold">Contract vs Market Price Analysis</h2>
                <div className="flex gap-2">
                    <button
                        onClick={() => setTimePeriod('10day')}
                        className={`px-4 py-2 rounded ${timePeriod === '10day' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                        10 Days
                    </button>
                    <button
                        onClick={() => setTimePeriod('30day')}
                        className={`px-4 py-2 rounded ${timePeriod === '30day' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                        30 Days
                    </button>
                    <button
                        onClick={() => setTimePeriod('90day')}
                        className={`px-4 py-2 rounded ${timePeriod === '90day' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                        90 Days
                    </button>
                    <button
                        onClick={() => setTimePeriod('1year')}
                        className={`px-4 py-2 rounded ${timePeriod === '1year' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                        1 Year
                    </button>
                </div>
            </div>

            {/* Aluminum Graph */}
            <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-lg font-semibold mb-4">Aluminum 5052 - Contract Prices vs Market</h3>
                
                {aluminumData.length > 0 ? (
                    <>
                        {/* Floor and Ceiling Legend */}
                        <div className="mb-4 flex gap-6 text-sm">
                            {alFloor !== null && (
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-0.5 bg-green-600"></div>
                                    <span className="text-gray-700">
                                        Floor (Best Contract): <span className="font-semibold text-green-600">${alFloor.toFixed(4)}/lb</span>
                                    </span>
                                </div>
                            )}
                            {alCeiling !== null && (
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-0.5 bg-red-600"></div>
                                    <span className="text-gray-700">
                                        Ceiling (Peak Market): <span className="font-semibold text-red-600">${alCeiling.toFixed(4)}/lb</span>
                                    </span>
                                </div>
                            )}
                        </div>
                        
                        {/* Chart */}
                        <ResponsiveContainer width="100%" height={400}>
                            <LineChart data={aluminumData}>
                                <CartesianGrid strokeDasharray="3 3" />
                                <XAxis 
                                    dataKey="date" 
                                    tick={{ fontSize: 12 }}
                                    angle={-45}
                                    textAnchor="end"
                                    height={80}
                                />
                                <YAxis 
                                    label={{ value: '$/lb', angle: -90, position: 'insideLeft' }}
                                    domain={['auto', 'auto']}
                                    tick={{ fontSize: 12 }}
                                />
                                <Tooltip content={<CustomTooltip />} />
                                <Legend wrapperStyle={{ paddingTop: '20px' }} />
                                
                                {/* Floor line */}
                                {alFloor !== null && (
                                    <ReferenceLine 
                                        y={alFloor} 
                                        stroke="#16a34a" 
                                        strokeDasharray="3 3" 
                                        label={{ value: 'Floor', position: 'right', fill: '#16a34a', fontSize: 12 }}
                                    />
                                )}
                                
                                {/* Ceiling line */}
                                {alCeiling !== null && (
                                    <ReferenceLine 
                                        y={alCeiling} 
                                        stroke="#dc2626" 
                                        strokeDasharray="3 3" 
                                        label={{ value: 'Ceiling', position: 'right', fill: '#dc2626', fontSize: 12 }}
                                    />
                                )}
                                
                                {/* Market price line */}
                                <Line 
                                    type="monotone" 
                                    dataKey="market" 
                                    stroke="#3b82f6" 
                                    strokeWidth={3}
                                    name="Market Price"
                                    dot={{ r: 4 }}
                                />
                                
                                {/* Contract lines */}
                                {getAluminumVendors().map((vendor, idx) => (
                                    <Line 
                                        key={vendor}
                                        type="monotone" 
                                        dataKey={vendor} 
                                        stroke={contractColors[idx % contractColors.length]}
                                        strokeWidth={2}
                                        name={vendor}
                                        dot={{ r: 3 }}
                                        connectNulls
                                    />
                                ))}
                            </LineChart>
                        </ResponsiveContainer>
                        
                        {/* Vendor Summary Cards */}
                        <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                            {getAluminumVendors().map((vendor, idx) => {
                                const contract = contracts.find(c => c.vendor === vendor && c.material === 'aluminum5052');
                                const latestMarket = aluminumData.length > 0 ? aluminumData[aluminumData.length - 1].market : 0;
                                const savings = latestMarket ? (latestMarket - parseFloat(contract?.pricePerLb || 0)) * 100 : 0;
                                const savingsPercent = latestMarket ? (savings / 100 / latestMarket) * 100 : 0;
                                
                                return (
                                    <div key={vendor} className="border rounded p-3 bg-gray-50">
                                        <div className="flex items-center gap-2 mb-1">
                                            <div 
                                                className="w-3 h-3 rounded-full" 
                                                style={{ backgroundColor: contractColors[idx % contractColors.length] }}
                                            ></div>
                                            <span className="font-semibold text-sm">{vendor}</span>
                                        </div>
                                        <div className="text-xs text-gray-600">
                                            Contract: ${contract?.pricePerLb}/lb
                                        </div>
                                        <div className={`text-xs font-semibold mt-1 ${savings > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {savings > 0 ? 'â†“' : 'â†‘'} ${Math.abs(savings).toFixed(4)} ({Math.abs(savingsPercent).toFixed(1)}%)
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </>
                ) : (
                    <div className="text-center py-12 text-gray-500">
                        <p>No data available for the selected time period.</p>
                        <p className="text-sm mt-2">Add market prices and contracts to see the graph.</p>
                    </div>
                )}
            </div>

            {/* Stainless Steel Graph - Similar structure as Aluminum */}
            <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-lg font-semibold mb-4">Stainless Steel 304 2B - Contract Prices vs Market</h3>
                
                {stainlessData.length > 0 ? (
                    <>
                        <div className="mb-4 flex gap-6 text-sm">
                            {ssFloor !== null && (
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-0.5 bg-green-600"></div>
                                    <span className="text-gray-700">
                                        Floor (Best Contract): <span className="font-semibold text-green-600">${ssFloor.toFixed(4)}/lb</span>
                                    </span>
                                </div>
                            )}
                            {ssCeiling !== null && (
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-0.5 bg-red-600"></div>
                                    <span className="text-gray-700">
                                        Ceiling (Peak Market): <span className="font-semibold text-red-600">${ssCeiling.toFixed(4)}/lb</span>
                                    </span>
                                </div>
                            )}
                        </div>
                        
                        <ResponsiveContainer width="100%" height={400}>
                            <LineChart data={stainlessData}>
                                <CartesianGrid strokeDasharray="3 3" />
                                <XAxis 
                                    dataKey="date" 
                                    tick={{ fontSize: 12 }}
                                    angle={-45}
                                    textAnchor="end"
                                    height={80}
                                />
                                <YAxis 
                                    label={{ value: '$/lb', angle: -90, position: 'insideLeft' }}
                                    domain={['auto', 'auto']}
                                    tick={{ fontSize: 12 }}
                                />
                                <Tooltip content={<CustomTooltip />} />
                                <Legend wrapperStyle={{ paddingTop: '20px' }} />
                                
                                {ssFloor !== null && (
                                    <ReferenceLine 
                                        y={ssFloor} 
                                        stroke="#16a34a" 
                                        strokeDasharray="3 3" 
                                        label={{ value: 'Floor', position: 'right', fill: '#16a34a', fontSize: 12 }}
                                    />
                                )}
                                
                                {ssCeiling !== null && (
                                    <ReferenceLine 
                                        y={ssCeiling} 
                                        stroke="#dc2626" 
                                        strokeDasharray="3 3" 
                                        label={{ value: 'Ceiling', position: 'right', fill: '#dc2626', fontSize: 12 }}
                                    />
                                )}
                                
                                <Line 
                                    type="monotone" 
                                    dataKey="market" 
                                    stroke="#a855f7" 
                                    strokeWidth={3}
                                    name="Market Price"
                                    dot={{ r: 4 }}
                                />
                                
                                {getStainlessVendors().map((vendor, idx) => (
                                    <Line 
                                        key={vendor}
                                        type="monotone" 
                                        dataKey={vendor} 
                                        stroke={contractColors[idx % contractColors.length]}
                                        strokeWidth={2}
                                        name={vendor}
                                        dot={{ r: 3 }}
                                        connectNulls
                                    />
                                ))}
                            </LineChart>
                        </ResponsiveContainer>
                        
                        <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                            {getStainlessVendors().map((vendor, idx) => {
                                const contract = contracts.find(c => c.vendor === vendor && c.material === 'stainless304');
                                const latestMarket = stainlessData.length > 0 ? stainlessData[stainlessData.length - 1].market : 0;
                                const savings = latestMarket ? (latestMarket - parseFloat(contract?.pricePerLb || 0)) * 100 : 0;
                                const savingsPercent = latestMarket ? (savings / 100 / latestMarket) * 100 : 0;
                                
                                return (
                                    <div key={vendor} className="border rounded p-3 bg-gray-50">
                                        <div className="flex items-center gap-2 mb-1">
                                            <div 
                                                className="w-3 h-3 rounded-full" 
                                                style={{ backgroundColor: contractColors[idx % contractColors.length] }}
                                            ></div>
                                            <span className="font-semibold text-sm">{vendor}</span>
                                        </div>
                                        <div className="text-xs text-gray-600">
                                            Contract: ${contract?.pricePerLb}/lb
                                        </div>
                                        <div className={`text-xs font-semibold mt-1 ${savings > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {savings > 0 ? 'â†“' : 'â†‘'} ${Math.abs(savings).toFixed(4)} ({Math.abs(savingsPercent).toFixed(1)}%)
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </>
                ) : (
                    <div className="text-center py-12 text-gray-500">
                        <p>No data available for the selected time period.</p>
                        <p className="text-sm mt-2">Add market prices and contracts to see the graph.</p>
                    </div>
                )}
            </div>
        </div>
    );
};

            const MarketPricesView = () => {
                const latest = getLatestMarketPrice();
                
                return (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Market Prices</h2>
                            <button
                                onClick={() => {
                                    setEditingMarketPrice(null);
                                    setShowMarketPriceForm(true);
                                }}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                                <Plus size={20} />
                                Enter Prices
                            </button>
                        </div>

                        {latest && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-lg font-semibold mb-4">Latest Aluminum Pricing</h3>
                                    <div className="space-y-3">
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">LME Aluminum:</span>
                                            <span className="font-semibold">${latest.lmeAluminum || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">Aluminum Base:</span>
                                            <span className="font-semibold">${latest.aluminumBase || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">Midwest Premium:</span>
                                            <span className="font-semibold">${latest.midwestPremium || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t">
                                            <span className="font-semibold text-blue-700">Market Total (Base+MW):</span>
                                            <span className="font-bold text-blue-700">
                                                ${calculateMarketPrice('aluminum5052')?.total.toFixed(4) || '-'}/lb
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-500 text-right pt-2">
                                            Updated: {latest.date}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-lg font-semibold mb-4">Latest Stainless Pricing</h3>
                                    <div className="space-y-3">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Nickel:</span>
                                            <span className="font-semibold">${latest.nickel || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Chrome:</span>
                                            <span className="font-semibold">${latest.chrome || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Molybdenum:</span>
                                            <span className="font-semibold">${latest.molybdenum || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Scrap Iron:</span>
                                            <span className="font-semibold">${latest.scrapIron || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Conversion Pricing:</span>
                                            <span className="font-semibold">${latest.conversionPricing || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm pt-2 border-t">
                                            <span className="text-gray-600">NAS Surcharge:</span>
                                            <span className="font-semibold">${latest.nasStainlessSurcharge || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Outokumpu Surcharge:</span>
                                            <span className="font-semibold">${latest.outokumpuSurcharge || '-'}/lb</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t">
   														 <span className="font-semibold text-purple-700">Market Total (Ni+Cr+Scrap+Conv):</span>
   														 <span className="font-bold text-purple-700">
        														${calculateMarketPrice('stainless304')?.total.toFixed(4) || '-'}/lb
    														</span>
					</div>
                                        <div className="text-xs text-gray-500 text-right pt-2">
                                            Updated: {latest.date}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="px-6 py-4 bg-gray-50 border-b">
                                <h3 className="font-semibold">Price History</h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">LME Al</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Al Base</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">MW Prem</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nickel</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Conversion</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NAS Surch</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {marketPrices.map(price => (
                                            <tr key={price.id}>
                                                <td className="px-6 py-4">{price.date}</td>
                                                <td className="px-6 py-4">${price.lmeAluminum || '-'}</td>
                                                <td className="px-6 py-4">${price.aluminumBase || '-'}</td>
                                                <td className="px-6 py-4">${price.midwestPremium || '-'}</td>
                                                <td className="px-6 py-4">${price.nickel || '-'}</td>
                                                <td className="px-6 py-4">${price.conversionPricing || '-'}</td>
                                                <td className="px-6 py-4">${price.nasStainlessSurcharge || '-'}</td>
                                                <td className="px-6 py-4 text-sm text-gray-600">{price.notes || '-'}</td>
                                                <td className="px-6 py-4">
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => {
                                                                setEditingMarketPrice(price);
                                                                setShowMarketPriceForm(true);
                                                            }}
                                                            className="text-blue-600 hover:text-blue-800 text-sm"
                                                        >
                                                            Edit
                                                        </button>
                                                        <button
                                                            onClick={() => deleteMarketPrice(price.id)}
                                                            className="text-red-600 hover:text-red-800 text-sm"
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            {marketPrices.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    No market prices recorded yet. Click "Enter Prices" to get started.
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <div className="bg-blue-600 text-white p-4 shadow-lg">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold">Materials Management System</h1>
                                <p className="text-sm text-blue-100">Sheet Metal Procurement & Contract Tracking</p>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => {
                                        const key = prompt('Enter your Metals-API.com API key:\n\n1. Sign up free at https://metals-api.com\n2. Get your API key from the dashboard\n3. Paste it here\n\nLeave blank to use demo mode.');
                                        if (key !== null) {
                                            localStorage.setItem('metalsApiKey', key || 'DEMO_KEY');
                                            alert(key ? 'API key saved successfully!' : 'Using demo mode with sample prices.');
                                        }
                                    }}
                                    className="px-4 py-2 bg-white text-blue-600 rounded hover:bg-blue-50 font-medium text-sm"
                                    title="Configure API key for live price fetching"
                                >
                                    âš™ï¸ Set API Key
                                </button>
                                <button
                                    onClick={exportAllData}
                                    className="px-4 py-2 bg-white text-blue-600 rounded hover:bg-blue-50 font-medium"
                                >
                                    Export Data
                                </button>
                                <label className="px-4 py-2 bg-white text-blue-600 rounded hover:bg-blue-50 font-medium cursor-pointer">
                                    Import Data
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={importAllData}
                                        className="hidden"
                                    />
                                </label>
                                <button
                                    onClick={() => setShowImportDialog(true)}
                                    className="px-4 py-2 bg-white text-blue-600 rounded hover:bg-blue-50 font-medium"
                                >
                                    Import from Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-4">
                        <div className="bg-white rounded-lg shadow mb-6">
                            <div className="flex border-b">
                                <button
                                    onClick={() => setActiveTab('dashboard')}
                                    className={`px-6 py-3 font-medium ${
                                        activeTab === 'dashboard'
                                            ? 'border-b-2 border-blue-600 text-blue-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Dashboard
                                </button>
                                <button
                                    onClick={() => setActiveTab('contracts')}
                                    className={`px-6 py-3 font-medium ${
                                        activeTab === 'contracts'
                                            ? 'border-b-2 border-blue-600 text-blue-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Contracts
                                </button>
                                <button
                                    onClick={() => setActiveTab('usage')}
                                    className={`px-6 py-3 font-medium ${
                                        activeTab === 'usage'
                                            ? 'border-b-2 border-blue-600 text-blue-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Usage History
                                </button>
				<button
      												 onClick={() => setActiveTab('bids')}
       												className={`px-6 py-3 font-medium ${
          				 								activeTab === 'bids'
               													? 'border-b-2 border-blue-600 text-blue-600'
               													: 'text-gray-600 hover:text-gray-800'
       												}`}
   											>
       												Contract Bids
   											</button>

                                <button
    												onClick={() => setActiveTab('market')}
    												className={`px-6 py-3 font-medium ${
        												activeTab === 'market'
            													? 'border-b-2 border-blue-600 text-blue-600'
            													: 'text-gray-600 hover:text-gray-800'
    												}`}
				>
    												Market Prices
				</button>
				<button
    												onClick={() => setActiveTab('graphs')}
    												className={`px-6 py-3 font-medium ${
       													 activeTab === 'graphs'
           													 ? 'border-b-2 border-blue-600 text-blue-600'
           													 : 'text-gray-600 hover:text-gray-800'
    												}`}
				>
    												Graphs
				</button>
				<button
    												onClick={() => setActiveTab('scrap')}
    												className={`px-6 py-3 font-medium ${
       													 activeTab === 'scrap'
           													 ? 'border-b-2 border-green-600 text-green-600'
           													 : 'text-gray-600 hover:text-gray-800'
    												}`}
				>
				    <span className="flex items-center gap-2">
				        <Recycle size={18} />
				        Scrap
				    </span>
				</button>
				</div>
				</div>
                        
				{activeTab === 'dashboard' && <Dashboard />}
				{activeTab === 'contracts' && <ContractsView />}
				{activeTab === 'bids' && <ContractBidsView />}
				{activeTab === 'usage' && <UsageView />}
				{activeTab === 'market' && <MarketPricesView />}
				{activeTab === 'graphs' && <GraphsView />}
				{activeTab === 'scrap' && <ScrapView />}
                    </div>

                    {showContractForm && (
                        <ContractForm
                            onClose={() => {
                                setShowContractForm(false);
                                setEditingContract(null);
                            }}
                            onSubmit={editingContract ? updateContract : addContract}
                            initialData={editingContract}
                        />
                    )}

                    {showUsageForm && (
                        <UsageForm
                            onClose={() => {
                                setShowUsageForm(false);
                                setEditingUsage(null);
                            }}
                            onSubmit={editingUsage ? updateUsage : addUsage}
                            initialData={editingUsage}
                        />
                    )}

                    {showMarketPriceForm && (
                        <MarketPriceForm
                            onClose={() => {
                                setShowMarketPriceForm(false);
                                setEditingMarketPrice(null);
                            }}
                            onSubmit={editingMarketPrice ? updateMarketPrice : addMarketPrice}
                            initialData={editingMarketPrice}
                        />
                    )}

                    {showInventoryForm && (
                        <InventoryForm
                            onClose={() => setShowInventoryForm(false)}
                            onSubmit={updateInventory}
                            currentInventory={inventory}
                        />
                    )}
		   {showBidPackageForm && (
       								<BidPackageForm
           								onClose={() => {
               									setShowBidPackageForm(false);
               									setEditingBidPackage(null);
           					  		}}
           							onSubmit={(pkg) => {
               									if (editingBidPackage) {
                   									setBidPackages(bidPackages.map(p => p.id === pkg.id ? pkg : p));
               									} else {
                   									setBidPackages([...bidPackages, pkg]);
               									}
           							}}
           							initialData={editingBidPackage}
       							/>
  						 )}
		  {showBidForm && selectedBidPackage && (
       							<BidForm
           							onClose={() => {
               								setShowBidForm(false);
               								setEditingBid(null);
           						}}
           						onSubmit={(bid) => {
               							if (editingBid) {
                   							setBids(bids.map(b => b.id === bid.id ? bid : b));
               						} else {
                   							setBids([...bids, bid]);
               						}
           					}}
           					bidPackage={selectedBidPackage}
           					initialData={editingBid}
       					/>
  				 )}

                    {showImportDialog && (
                        <ImportDialog
                            onClose={() => {
                                setShowImportDialog(false);
                            }}
                        />
                    )}

                    {showScrapContractForm && (
                        <ScrapContractForm
                            onClose={() => {
                                setShowScrapContractForm(false);
                                setEditingScrapContract(null);
                            }}
                            onSubmit={(contract) => {
                                if (editingScrapContract) {
                                    setScrapContracts(scrapContracts.map(c => c.id === contract.id ? contract : c));
                                } else {
                                    setScrapContracts([...scrapContracts, contract]);
                                }
                            }}
                            initialData={editingScrapContract}
                        />
                    )}

                    {showScrapBidForm && (
                        <ScrapBidForm
                            onClose={() => {
                                setShowScrapBidForm(false);
                                setEditingScrapBid(null);
                            }}
                            onSubmit={(bid) => {
                                if (editingScrapBid) {
                                    setScrapBids(scrapBids.map(b => b.id === bid.id ? bid : b));
                                } else {
                                    setScrapBids([...scrapBids, bid]);
                                }
                            }}
                            site={showScrapBidForm}
                            initialData={editingScrapBid}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MaterialsManagement />);
    </script>
</body>
</html>
